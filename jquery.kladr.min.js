!function(e){function t(e){var t={},n={token:"token",key:"key",type:"contentType",name:"query",withParents:"withParent",limit:"limit"};e.parentType&&e.parentId&&(t[e.parentType+"Id"]=e.parentId);for(var r in e)e.hasOwnProperty(r)&&n.hasOwnProperty(r)&&e[r]&&(t[n[r]]=e[r]);return t}function n(e){window.console&&window.console.error&&window.console.error(e)}e.kladr={},e.kladr.url="http://kladr-api.ru/api.php",e.kladr.type={region:"region",district:"district",city:"city",street:"street",building:"building"},e.kladr.validate=function(t){switch(t.type){case e.kladr.type.region:case e.kladr.type.district:case e.kladr.type.city:if(t.parentType&&!t.parentId)return n("parentId undefined"),!1;break;case e.kladr.type.street:if(t.parentType!=e.kladr.type.city)return n('parentType must equal "city"'),!1;if(!t.parentId)return n("parentId undefined"),!1;break;case e.kladr.type.building:if(t.parentType!=e.kladr.type.street)return n('parentType must equal "street"'),!1;if(!t.parentId)return n("parentId undefined"),!1;break;default:return n("type incorrect"),!1}return t.limit<1?(n("limit must greater than 0"),!1):!0},e.kladr.api=function(r,a){if(!a)return void n("Callback undefined");if(!e.kladr.validate(r))return void a([]);var i=e.Deferred();i.done(a),i.fail(function(e){n(e),a([])}),e.getJSON(e.kladr.url+"?callback=?",t(r),function(e){i.resolve(e.result)}),setTimeout(function(){i.reject("Request error")},3e3)},e.kladr.check=function(t,r){return r?(t.withParents=!1,t.limit=1,void e.kladr.api(t,function(e){r(e&&e.length?e[0]:!1)})):void n("Callback undefined")}}(jQuery),function(e,t){function n(n,r){function u(e,n){return e.isGet?d.get(e.str[0]):(d.set(e),n(),t)}var d=function(){var r=n.data("kladr-data");return r||(r=e.extend({},i,o),n.data("kladr-data",r)),{set:function(e){if(e.obj)for(var t in e.obj)e.obj.hasOwnProperty(t)&&i.hasOwnProperty(t)&&(r[t]=e.obj[t]);else e.str&&e.str.length>1&&i.hasOwnProperty(e.str[0])&&(r[e.str[0]]=e.str[1]);n.data("kladr-data",r)},get:function(e){return i.hasOwnProperty(e)||o.hasOwnProperty(e)?r[e]:t},_set:function(e,t){r[e]=t,n.data("kladr-data",r)},_get:function(e){return r.hasOwnProperty(e)?r[e]:t}}}();return u(r,function(){function r(t){var r=e(document.getElementById("kladr_autocomplete"));r.length||(r=e('<div id="kladr_autocomplete"></div>').appendTo(document.body));var i=I("guid");i?(O=r.find(".autocomplete"+i),C=r.find(".spinner"+i),n.off(".kladr"),O.off(".kladr")):(i=a(),P("guid",i),n.attr("autocomplete","off"),O=e('<ul class="autocomplete'+i+' autocomplete" style="display: none;"></ul>').appendTo(r),C=e('<div class="spinner'+i+' spinner" style="display: none;"></div>').appendTo(r),o()),t()}function i(t,n){var r,a,i,o;O.empty();for(var l in t)t.hasOwnProperty(l)&&(r=t[l],a=I("valueFormat")(r,n),i=I("labelFormat")(r,n),o=e('<a data-val="'+a+'">'+i+"</a>"),o.data("kladr-object",r),e("<li></li>").append(o).appendTo(O))}function o(){var e=n.offset(),t=n.outerWidth(),r=n.outerHeight();if(o.top!=e.top||o.left!=e.left||o.width!=t||o.height!=r){o.top=e.top,o.left=e.left,o.width=t,o.height=r,O.css({top:e.top+r+"px",left:e.left});var a=O.outerWidth()-O.width();O.width(t-a);var i=C.width(),l=C.height();C.css({top:e.top+(r-l)/2-1,left:e.left+t-i-2})}}function u(t){if(!(t.which>8&&t.which<46)){if(!h("open_before"))return void s();var r=n.val();if(!e.trim(r))return T(!1),void s();var a=g(r);if(!h("send_before",a))return void s();y(),h("send"),I("source")(a,function(t){return h("received"),n.is(":focus")&&e.trim(n.val())&&t.length?(i(t,a),o(),k(),O.slideDown(50),void h("open")):(k(),void s())})}}function s(){h("close_before")&&(O.empty().hide(),h("close"))}function c(e){var n=O.find("li.active");switch(e.which){case l.up:n.length?(n.removeClass("active"),n.prev().length&&(n=n.prev())):n=O.find("li").last(),function(){var e=O.scrollTop(),t=O.offset(),r=n.outerHeight(),a=n.offset();a.top-t.top<0&&O.scrollTop(e-r)}(),n.addClass("active"),p();break;case l.down:n.length?(n.removeClass("active"),n.next().length&&(n=n.next())):n=O.find("li").first(),function(){var e=O.scrollTop(),t=O.height(),r=O.offset(),a=n.outerHeight(),i=n.offset();i.top-r.top+a>t&&O.scrollTop(e+a)}(),n.addClass("active"),p();break;case l.enter:s()}return t}function f(){var t=e(this);return t.is("a")&&(t=t.parents("li")),t.addClass("active"),p(),s(),n.focus(),!1}function p(){if(h("select_before")){var e=O.find(".active a");e.length&&(n.val(e.attr("data-val")),T(!1),b(e.data("kladr-object")),h("select",I("current")))}}function v(){function t(e,t){T(t),b(e)}if(I("verify")&&h("check_before")){var r=e.trim(n.val());if(!r)return void t(null,!1);var a=g(r);if(a.withParents=!1,a.limit=10,!h("send_before",a))return t(null,!1),void h("check",null);y(),h("send"),I("source")(a,function(r){function i(e,n){k(),t(e,n)}if(h("received"),!e.trim(n.val()))return void i(null,!1);var o=a.name.toLowerCase(),l=null,u=null;for(var d in r)if(r.hasOwnProperty(d)&&(l=r[d].name.toLowerCase(),o==l)){u=r[d];break}u&&n.val(I("valueFormat")(u,a)),i(u,!u),h("check",u)})}}function h(t,r){if(!t)return!0;var a=t.replace(/_([a-z])/gi,function(e,t){return t.toUpperCase()});return n.trigger("kladr_"+t,r),"function"===e.type(I(a))?I(a).call(n.get(0),r):!0}function y(){I("spinner")&&I("showSpinner")(C)}function k(){I("spinner")&&I("hideSpinner")(C)}function g(e){var t,n={token:I("token"),key:I("key"),type:I("type"),name:w(e),parentType:I("parentType"),parentId:I("parentId"),withParents:I("withParents"),limit:I("limit")},r=I("parentInput");return r&&(t=m(r,n.type),t&&(n.parentType=t.type,n.parentId=t.id)),n}function m(t,n){var r,a=e.getKladrInputs(t),i=I("getTypes")(),o={},l=null;a.each(function(){var t,n=e(this);(t=n.attr("data-kladr-id"))&&(o[n.attr("data-kladr-type")]=t)});for(r in i){if(r==n)return l;i.hasOwnProperty(r)&&o[r]&&(l={type:r,id:o[r]})}return l}function w(e){for(var t,n,r="abcdefghijklmnopqrstuvwxyz",a="Ёё",i="Ее",o=e.toLowerCase(),l="",u=0;u<o.length;u++){if(r.indexOf(o[u])>-1)return T(!0),e;t=e[u],n=a.indexOf(t),l+=n>-1?i[n]:t}return T(!1),l}function b(e){P("current",e),e&&e.id&&n.attr("data-kladr-id",e.id)}function T(e){e?n.addClass("kladr-error"):n.removeClass("kladr-error")}function I(e){return d._get(e)}function P(e,t){d._set(e,t)}var O=null,C=null;r(function(){var e=!1;n.attr("data-kladr-type",I("type")).on("keyup.kladr",u).on("keydown.kladr",c).on("blur.kladr",function(){v(),e||s()}),O.on("touchstart.kladr click.kladr","li, a",f).on("touchstart.kladr mouseenter.kladr","li",function(){e=!0}).on("touchend.kladr mouseleave.kladr","li",function(){e=!1})})})}function r(n){var r={obj:!1,str:!1,isGet:!1};if("object"===e.type(n))return r.obj=n,r;if("string"===e.type(n)){r.str=[];for(var a in arguments)arguments.hasOwnProperty(a)&&(r.str[a]=arguments[a]);r.str[1]===t&&(r.isGet=!0)}return r}function a(){return a.guid||(a.guid=0),++a.guid}var i={token:null,key:null,type:null,parentType:null,parentId:null,limit:10,withParents:!1,parentInput:null,verify:!1,spinner:!0,open:null,close:null,send:null,received:null,select:null,check:null,openBefore:null,closeBefore:null,sendBefore:null,selectBefore:null,checkBefore:null,source:function(t,n){e.kladr.api(t,n)},getTypes:function(){return e.kladr.type},labelFormat:function(e,t){var n="",r=e.name.toLowerCase(),a=t.name.toLowerCase(),i=r.indexOf(a);return i=i>0?i:0,e.typeShort&&(n+=e.typeShort+". "),a.length<r.length?(n+=e.name.substr(0,i),n+="<strong>"+e.name.substr(i,a.length)+"</strong>",n+=e.name.substr(i+a.length,r.length-a.length-i)):n+="<strong>"+e.name+"</strong>",n},valueFormat:function(e){return e.name},showSpinner:function(e){var t=-.2,n=setInterval(function(){return e.is(":visible")?(e.css("background-position","0% "+t+"%"),t+=5.555556,void(t>95&&(t=-.2))):(clearInterval(n),void(n=null))},30);e.show()},hideSpinner:function(e){e.hide()}},o={current:null},l={up:38,down:40,enter:13};e.fn.kladr=function(a,i){var o=r(a,i),l=t;return this.each(function(){var r=n(e(this),o);return o.isGet?(l=r,!1):t}),o.isGet?l:this},e.getKladrInputs=function(t){var n=e(),r="[data-kladr-type]";return e(t||document.body).each(function(){var t=e(this);n=n.add(t.is(r)?t:t.find(r))}),n}}(jQuery);