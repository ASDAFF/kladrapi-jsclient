(function(a){a.kladr={};a.kladr.url="http://kladr-api.ru/api.php";a.kladr.type={region:"region",district:"district",city:"city",street:"street",building:"building"};a.kladr.api=function(c,e){var b={};if(c.token){b.token=c.token}if(c.key){b.key=c.key}if(c.type){b.contentType=c.type}if(c.name){b.query=c.name}if(c.parentType&&c.parentId){b[c.parentType+"Id"]=c.parentId}if(c.withParents){b.withParent=1}b.limit=c.limit?c.limit:2000;var d=false;a.getJSON(a.kladr.url+"?callback=?",b,function(f){if(d){return}d=true;e&&e(f.result)});setTimeout(function(){if(d){return}d=true;console.error("Request error");e&&e([])},5000)};a.kladr.check=function(b,c){b.withParents=false;b.limit=1;a.kladr.api(b,function(d){if(d&&d.length){c&&c(d[0])}else{c&&c(false)}})}})(jQuery);(function(b,a){b.fn.kladr=function(d,e){this.each(function(){c(b(this),d,e)});function c(z,m,r){var u=null;var l=null;var x=null;var h={token:null,key:null,type:null,parentType:null,parentId:null,limit:10,withParents:false,verify:false,showSpinner:true,current:null,open:null,close:null,send:null,received:null,select:null,check:null,source:function(F,G){var E={token:x.token,key:x.token,type:x.type,name:F,parentType:x.parentType,parentId:x.parentId,withParents:x.withParents,limit:x.limit};b.kladr.api(E,G)},labelFormat:function(H,F){var E="";var I=H.name.toLowerCase();F=F.toLowerCase();var G=I.indexOf(F);G=G>0?G:0;if(H.typeShort){E+=H.typeShort+". "}if(F.length<H.name.length){E+=H.name.substr(0,G);E+="<strong>"+H.name.substr(G,F.length)+"</strong>";E+=H.name.substr(G+F.length,H.name.length-F.length-G)}else{E+="<strong>"+H.name+"</strong>"}return E},valueFormat:function(F,E){return F.name}};var A={up:38,down:40,esc:27,enter:13};var q=null;var p=function(F,G,H){x=z.data("kladr-options");if(G!==a){x[F]=G;z.data("kladr-options",x);return z}if(b.type(F)==="string"){if(!x){return null}return x[F]}if(x){return z}x=h;if(b.type(F)==="object"){for(var E in F){x[E]=F[E]}}z.data("kladr-options",x);H&&H();return z};var y=function(H){var I="1234567890qazwsxedcrfvtgbyhnujmik,ol.p;[']- QAZWSXEDCRFVTGBYHNUJMIK<OL>P:{\"} ";var F="1234567890йфяцычувскамепинртгоьшлбщдюзжхэъ- ЙФЯЦЫЧУВСКАМЕПИНРТГОЬШЛБЩДЮЗЖХЭЪ ";var K="";var G;var J;for(var E=0;E<H.length;E++){G=H[E];J=I.indexOf(G);if(J>-1){K+=F[J];continue}K+=G}return K};var t=function(E,F){if(!E){return}z.trigger("kladr_"+E,F);if(x[E]){x[E].call(z.get(0),F)}};var g=function(){var F=b(document.getElementById("kladr_autocomplete"));var E=z.attr("name");if(!F.length){F=b('<div id="kladr_autocomplete"></div>').appendTo("body")}z.attr("autocomplete","off");u=b('<ul class="kladr_autocomplete_'+E+'" style="display: none;"></ul>');u.appendTo(F);l=b('<div class="spinner kladr_autocomplete_'+E+'_spinner" class="spinner" style="display: none;"></div>');l.appendTo(F)};var B=function(){var E=z.offset();var G=z.outerWidth();var F=z.outerHeight();u.css({top:E.top+F+"px",left:E.left});var J=u.outerWidth()-u.width();u.width(G-J);var H=l.width();var I=l.height();l.css({top:E.top+(F-I)/2-1,left:E.left+G-H-2,})};var j=function(I,K){u.empty();for(var F in I){var L=I[F];var E=x.valueFormat(L,K);var G=x.labelFormat(L,K);var H=b('<a data-val="'+E+'">'+G+"</a>");H.data("kladr-object",L);var J=b("<li></li>").append(H);J.appendTo(u)}};var w=function(){switch(x.type){case b.kladr.type.region:case b.kladr.type.district:case b.kladr.type.city:if(x.parentType&&!x.parentId){console.error("parentType is defined and parentId in not");return false}break;case b.kladr.type.street:if(x.parentType!=b.kladr.type.city){console.error('For street parentType must equal "city"');return false}if(!x.parentId){console.error("For street parentId must defined");return false}break;case b.kladr.type.building:if(x.parentType!=b.kladr.type.street){console.error('For building parentType must equal "street"');return false}if(!x.parentId){console.error("For building parentId must defined");return false}break;default:console.error('type must defined and equal "region", "district", "city", "street" or "building"');return false}if(x.limit<1){console.error("limit must greater than 0");return false}return true};var k=function(){var E=u.find(".active a");if(!E.length){return}z.val(E.attr("data-val"));x.current=E.data("kladr-object");z.data("kladr-options",x);t("select",x.current)};var v=function(){var E=b(this);if(E.is("li")){E=E.find("a")}k(E);C();z.focus();return false};var f=function(E){var F=u.find("li.active");switch(E.which){case A.up:if(F.length){F.removeClass("active");F=F.prev()}else{F=u.find("li").last()}F.addClass("active");k();break;case A.down:if(F.length){F.removeClass("active");F=F.next()}else{F=u.find("li").first()}F.addClass("active");k();break;case A.esc:F.removeClass("active");C();break;case A.enter:F.removeClass("active");C();return false}};var i=function(){if(!x.verify){return}if(!w()){return}var E=y(z.val());if(!b.trim(E)){return}D();t("send");x.source(E,function(H){o();t("received");var I=null;for(var G=0;G<H.length;G++){var F=E.toLowerCase();var J=H[G].name.toLowerCase();if(F==J){I=H[G];break}}if(I){z.val(x.valueFormat(I,E))}x.current=I;z.data("kladr-options",x);t("check",x.current)})};var s=function(F){if((F.which>8)&&(F.which<46)){return}if(!w()){return}var E=y(z.val());if(!b.trim(E)){C();return}D();t("send");x.source(E,function(G){o();t("received");if(!z.is(":focus")){C();return}if(!b.trim(z.val())||!G.length){C();return}j(G,E);B();u.slideDown(50);t("open")})};var C=function(){k();u.hide();t("close")};var n=function(){if(q){return}var E=-0.2;q=setInterval(function(){if(!l.is(":visible")){clearInterval(q);q=null;return}l.css("background-position","0% "+E+"%");E+=5.555556;if(E>95){E=-0.2}},30)};var D=function(){if(x.showSpinner){l.show();n()}};var o=function(){l.hide()};return p(m,r,function(){var E=false;g();B();z.keyup(s);z.keydown(f);z.change(i);z.blur(function(){if(!E){C()}});u.on("click","li, a",v);u.on("mouseenter","li",function(){b(this).addClass("active");E=true});u.on("mouseleave","li",function(){b(this).removeClass("active");E=false});b(window).resize(B)})}}})(jQuery);