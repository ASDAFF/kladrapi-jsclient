!function(t,e){function n(t){var e={},n={type:"contentType",name:"query",withParents:"withParent"};t.parentType&&t.parentId&&(e[t.parentType+"Id"]=t.parentId);for(var i in t)r(t,i)&&t[i]&&(e[r(n,i)?n[i]:i]=t[i]);return e}function r(t,e){return t.hasOwnProperty(e)}function i(t){var n=e.console;n&&n.error&&n.error(t)}t.kladr={},function(){var n="https:"==e.location.protocol?"https:":"http:";t.kladr.url=n+"//kladr-api.ru/api.php"}(),t.kladr.type={region:"region",district:"district",city:"city",street:"street",building:"building"},t.kladr.typeCode={city:1,settlement:2,village:4},t.kladr.validate=function(e){var n=t.kladr.type;switch(e.type){case n.region:case n.district:case n.city:if(e.parentType&&!e.parentId)return i("parentId undefined"),!1;break;case n.street:if(e.parentType!=n.city)return i('parentType must equal "city"'),!1;if(!e.parentId)return i("parentId undefined"),!1;break;case n.building:if(!e.zip){if(!~t.inArray(e.parentType,[n.street,n.city]))return i('parentType must equal "street" or "city"'),!1;if(!e.parentId)return i("parentId undefined"),!1}break;default:if(!e.oneString)return i("type incorrect"),!1}return e.oneString&&e.parentType&&!e.parentId?(i("parentId undefined"),!1):e.typeCode&&e.type!=n.city?(i('type must equal "city"'),!1):e.limit<1?(i("limit must greater than 0"),!1):!0},t.kladr.api=function(e,r){if(!r)return void i("Callback undefined");if(!t.kladr.validate(e))return void r([]);var a=setTimeout(function(){r([]),a=null},3e3);t.getJSON(t.kladr.url+"?callback=?",n(e),function(t){a&&(r(t.result||[]),clearTimeout(a))})},t.kladr.check=function(e,n){return n?(e.withParents=!1,e.limit=1,void t.kladr.api(e,function(t){n(t&&t.length?t[0]:!1)})):void i("Callback undefined")}}(jQuery,window),function(t,e,n,r){function i(r,i){function a(t,e){return t.isGet?c.get(t.str[0]):(c.set(t),void e())}var c=function(){var e="kladr-data",n=r.data(e);return n||(n=t.extend({},u,d),r.data(e,n)),{set:function(t){if(t.obj)for(var i in t.obj)l(t.obj,i)&&l(u,i)&&(n[i]=t.obj[i]);else t.str&&!t.isGet&&l(u,t.str[0])&&(n[t.str[0]]=t.str[1]);r.data(e,n)},get:function(t){return l(u,t)||l(d,t)?n[t]:void 0},_set:function(t,i){n[t]=i,r.data(e,n)},_get:function(t){return l(n,t)?n[t]:void 0}}}();return a(i,function(){function i(i){var a=t(n.getElementById("kladr_autocomplete"));a.length||(a=t('<div id="kladr_autocomplete"></div>').appendTo(n.body));var l=_("guid");l?(x=a.find(".autocomplete"+l),P=a.find(".spinner"+l),t(e).off(O),r.off(O),x.off(O)):(l=o(),B("guid",l),r.attr("autocomplete","off"),x=t('<ul class="autocomplete'+l+' autocomplete" style="display: none;"></ul>').appendTo(a),P=t('<div class="spinner'+l+' spinner" style="display: none;"></div>').appendTo(a),k(),u(),g()),i()}function a(e,n){var r,i,a,o;x.empty();for(var u in e)l(e,u)&&(r=e[u],i=_("valueFormat")(r,n),a=_("labelFormat")(r,n),o=t('<a data-val="'+i+'">'+a+"</a>"),o.data("kladr-object",r),t("<li></li>").append(o).appendTo(x))}function u(){var t=r.offset(),e=r.outerWidth(),n=r.outerHeight();if(t&&(u.top!=t.top||u.left!=t.left||u.width!=e||u.height!=n)){u.top=t.top,u.left=t.left,u.width=e,u.height=n,x.css({top:t.top+n+"px",left:t.left});var i=x.outerWidth()-x.width();x.width(e-i);var a=P.width(),o=P.height();P.css({top:t.top+(n-o)/2-1,left:t.left+e-a-2})}}function d(e){if(!(e.which>8&&e.which<46)){if(!m("open_before"))return void f();j(null);var n=r.val();if(!t.trim(n))return S(!1),void f();var i=T(n);if(!m("send_before",i))return void f();b(),m("send"),_("source")(i,function(e){return m("receive"),r.is(":focus")?t.trim(r.val())&&e.length?(a(e,i),u(),w(),x.slideDown(50),void m("open")):(w(),j(null),void f()):(w(),void f())})}}function f(){m("close_before")&&(x.empty().hide(),m("close"))}function p(t){var e=x.find("li.active");switch(t.which){case s.up:e.length?(e.removeClass("active"),e.prev().length&&(e=e.prev())):e=x.find("li").last(),function(){var t=x.scrollTop(),n=x.offset(),r=e.outerHeight(),i=e.offset();i.top-n.top<0&&x.scrollTop(t-r)}(),e.addClass("active"),y();break;case s.down:e.length?(e.removeClass("active"),e.next().length&&(e=e.next())):e=x.find("li").first(),function(){var t=x.scrollTop(),n=x.height(),r=x.offset(),i=e.outerHeight(),a=e.offset();a.top-r.top+i>n&&x.scrollTop(t+i)}(),e.addClass("active"),y();break;case s.enter:f()}}function v(){var e=t(this);return e.is("a")&&(e=e.parents("li")),e.addClass("active"),y(),f(),r.focus(),!1}function y(){if(m("select_before")){var t=x.find(".active a");t.length&&(r.val(t.attr("data-val")),S(!1),j(t.data("kladr-object")),m("select",_("current")))}}function h(){function e(t,e){S(e),j(t)}if(_("verify")&&m("check_before")){var n=t.trim(r.val());if(!n)return void e(null,!1);if(_("current"))return void S(!1);var i=T(n);if(i.withParents=!1,i.limit=10,!m("send_before",i))return e(null,!1),void m("check",null);b(),m("send"),_("source")(i,function(n){function a(t,n){w(),e(t,n)}if(m("receive"),!t.trim(r.val()))return void a(null,!1);var o=i.name.toLowerCase(),u=null,d=null;for(var s in n)if(l(n,s)&&(u=n[s].name.toLowerCase(),o==u)){d=n[s];break}d&&r.val(_("valueFormat")(d,i)),a(d,!d),m("check",d)})}}function k(){function e(t,e){r.val(t?_("valueFormat")(t,e):""),j(t)}var n={setValue:function(e){return"object"===t.type(e)?n.setValueByObject(e):"number"===t.type(e)?n.setValueById(e):"string"===t.type(e)?n.setValueByName(e):e?n:n.clear()},setValueByName:function(r){if(r=t.trim(r+"")){var i=T("");if(i.name=I(r),i.withParents=!1,i.limit=10,!m("send_before",i))return e(null,i),n;m("send"),_("source")(i,function(t){m("receive");var n=i.name.toLowerCase(),r=null,a=null;for(var o in t)if(l(t,o)&&(r=t[o].name.toLowerCase(),n==r)){a=t[o];break}e(a,i)})}return n},setValueById:function(r){var i=T("");return i.parentType=i.type,i.parentId=r,i.limit=1,t.kladr.api(i,function(t){t.length&&e(t[0],i)}),n},setValueByObject:function(t){return e(t,T("")),n},clear:function(){return e(null,null),n}};B("controller",n)}function g(){function e(){var e=r.val();if(e){var n=T(e),i=n.type,a=n.parentType,o=t.kladr.type,l=!0;return i==o.street&&a!=o.city&&(l=!1),i!=o.building||~t.inArray(a,[o.street,o.city])||(l=!1),l&&h(),!!_("current")}return!1}var n=0;!function i(){++n>5||e()||setTimeout(i,100)}()}function m(e,n){if(!e)return!0;var i=e.replace(/_([a-z])/gi,function(t,e){return e.toUpperCase()});return r.trigger("kladr_"+e,n),"function"===t.type(_(i))?_(i).call(r.get(0),n)!==!1:!0}function b(){_("spinner")&&_("showSpinner")(P)}function w(){_("spinner")&&_("hideSpinner")(P)}function T(t){var e,n={},r=["token","key","type","typeCode","parentType","parentId","oneString","withParents","limit"];for(e=0;e<r.length;e++)n[r[e]]=_(r[e]);n.name=I(t);var i,a=_("parentInput");return a&&(i=C(a,n.type),i&&(n.parentType=i.type,n.parentId=i.id)),n.oneString&&(n.withParents=!0),n}function C(e,n){var r,i=t.kladr.getInputs(e),a=t.kladr.type,o={},u=null;i.each(function(){var e,n=t(this);(e=n.attr("data-kladr-id"))&&(o[n.attr("data-kladr-type")]=e)});for(r in a){if(r==n)return u;l(a,r)&&o[r]&&(u={type:r,id:o[r]})}return u}function I(t){for(var e="abcdefghijklmnopqrstuvwxyz",n=t.toLowerCase(),r=0;r<n.length;r++)if(~e.indexOf(n[r]))return S(!0),t;return S(!1),t}function j(t){B("current",t),t&&t.id?r.attr("data-kladr-id",t.id):r.removeAttr("data-kladr-id"),_("oneString")&&t&&t.contentType&&r.attr("data-kladr-type",t.contentType)}function S(t){t?r.addClass("kladr-error"):r.removeClass("kladr-error")}function _(t){return c._get(t)}function B(t,e){c._set(t,e)}var x=null,P=null,O=".kladr";i(function(){var n=!1,i=!1;r.attr("data-kladr-type",_("type")||"").attr("data-kladr-one-string",_("oneString")||null).on("keyup"+O,d).on("keydown"+O,p).on("blur"+O+" change"+O,function(){n||(i&&(i=!1,h()),f())}).on("focus"+O,function(){i=!0}),x.on("touchstart"+O+" click"+O,"li, a",function(){n=!0,v.call(this),n=!1}).on("mouseenter"+O,function(){n=!0}).on("mouseleave"+O,function(){n=!1}),t(e).on("resize"+O,u)})})}function a(e,n){var i={obj:!1,str:!1,isGet:!1};return"object"===t.type(e)?(i.obj=e,i):("string"===t.type(e)&&(i.str=[e,n],i.isGet=n===r),i)}function o(){return o.guid?++o.guid:o.guid=1}function l(t,e){return t.hasOwnProperty(e)}var u={token:null,key:null,type:null,typeCode:null,parentType:null,parentId:null,limit:10,oneString:!1,withParents:!1,parentInput:null,verify:!1,spinner:!0,open:null,close:null,send:null,receive:null,select:null,check:null,openBefore:null,closeBefore:null,sendBefore:null,selectBefore:null,checkBefore:null,source:function(e,n){t.kladr.api(e,n)},labelFormat:function(e,n){var r;if(n.oneString)return e.parents?(r=t.extend(!0,[],e.parents),r.push(e),t.kladr.buildAddress(r)):(e.typeShort?e.typeShort+". ":"")+e.name;var i,a,o,l,u="";return e.typeShort&&(u+=e.typeShort+". "),i=e.name,a=i.toLowerCase(),o=n.name.toLowerCase(),l=a.indexOf(o),l=~l?l:0,o.length<a.length?(u+=i.substr(0,l),u+="<strong>"+i.substr(l,o.length)+"</strong>",u+=i.substr(l+o.length)):u+="<strong>"+i+"</strong>",u},valueFormat:function(e,n){var r;return n.oneString?e.parents?(r=t.extend(!0,[],e.parents),r.push(e),t.kladr.buildAddress(r)):(e.typeShort?e.typeShort+". ":"")+e.name:e.name},showSpinner:function(t){var e=-.2,n=setInterval(function(){return t.is(":visible")?(t.css("background-position","0% "+e+"%"),e+=5.555556,void(e>95&&(e=-.2))):(clearInterval(n),void(n=null))},30);t.show()},hideSpinner:function(t){t.hide()}},d={current:null,controller:null},s={up:38,down:40,enter:13};t.kladr=t.extend(t.kladr,{setDefault:function(t,e){var n=a(t,e);if(n.obj)for(var r in n.obj)l(u,r)&&(u[r]=n.obj[r]);else n.str&&!n.isGet&&l(u,n.str[0])&&(u[n.str[0]]=n.str[1])},getDefault:function(t){return l(u,t)?u[t]:void 0},getInputs:function(e){var r=t(e||n.body),i="[data-kladr-type]";return r.filter(i).add(r.find(i))},getAddress:function(e,n){var r,i=t.kladr.getInputs(e),a=t.kladr.type,o={},u={};i.each(function(){var e,n,r,i=t(this);if(i.attr("data-kladr-id"))if(e=i.kladr("current"),i.attr("data-kladr-one-string")&&e.parents){n=t.extend(!0,[],e.parents),n.push(e);for(r in n)l(n,r)&&(o[n[r].contentType]=n[r])}else o[i.attr("data-kladr-type")]=e;else o[i.attr("data-kladr-type")]=i.val()});for(r in a)l(a,r)&&o[r]&&(u[r]=o[r]);return(n||t.kladr.buildAddress)(u)},buildAddress:function(e){var n,r,i=[],a="",o="",u="",d="";t:for(n in e)if(l(e,n)){if("object"===t.type(e[n])){for(r=0;r<i.length;r++)if(i[r]==e[n].id)continue t;i.push(e[n].id),u=e[n].name,d=e[n].typeShort+". ",o=e[n].zip||o}else u=e[n],d="";a&&(a+=", "),a+=d+u}return a=(o?o+", ":"")+a}}),t.fn.kladr=function(e,n){var r=a(e,n),o=null;return this.each(function(){var e=i(t(this),r);return r.isGet?(o=e,!1):void 0}),r.isGet?o:this}}(jQuery,window,document),function(t){t.fn.kladrZip=function(e){var n=t(e||document.body);return this.keydown(function(e){var n=e.charCode||e.keyCode||0,r=8==n||9==n||13==n||46==n||110==n||190==n||n>=35&&40>=n||n>=96&&105>=n;return t(this).val().length>=6?r:r||n>=48&&57>=n}),this.keyup(function(){function e(t){t?r.addClass("kladr-error"):r.removeClass("kladr-error")}var r=t(this),i=r.val();return i?void t.kladr.api({type:t.kladr.type.building,zip:i,withParents:!0,limit:1},function(r){var i,a,o=r.length&&r[0];if(r=[],o){e(!1),o.parents&&(r=t.extend(!0,[],o.parents)),r.push(o);for(i in r)r.hasOwnProperty(i)&&(a=n.find('[data-kladr-type="'+r[i].contentType+'"]'),a.kladr("controller").setValueByObject(r[i]))}else e(!0)}):void e(!1)}),this}}(jQuery);