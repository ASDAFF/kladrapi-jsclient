!function(e){function t(e){var t={},r={token:"token",key:"key",type:"contentType",typeCode:"typeCode",name:"query",zip:"zip",withParents:"withParent",oneString:"oneString",limit:"limit"};e.parentType&&e.parentId&&(t[e.parentType+"Id"]=e.parentId);for(var a in e)n(e,a)&&n(r,a)&&e[a]&&(t[r[a]]=e[a]);return t}function n(e,t){return e.hasOwnProperty(t)}function r(e){window.console&&window.console.error&&window.console.error(e)}e.kladr={},e.kladr.url="http://kladr-api.ru/api.php",e.kladr.type={region:"region",district:"district",city:"city",street:"street",building:"building"},e.kladr.typeCode={city:1,settlement:2,village:4},e.kladr.validate=function(t){switch(t.type){case e.kladr.type.region:case e.kladr.type.district:case e.kladr.type.city:if(t.parentType&&!t.parentId)return r("parentId undefined"),!1;break;case e.kladr.type.street:if(t.parentType!=e.kladr.type.city)return r('parentType must equal "city"'),!1;if(!t.parentId)return r("parentId undefined"),!1;break;case e.kladr.type.building:if(!t.zip){if(t.parentType!=e.kladr.type.street)return r('parentType must equal "street"'),!1;if(!t.parentId)return r("parentId undefined"),!1}break;default:if(!t.oneString)return r("type incorrect"),!1}return t.oneString&&t.parentType&&!t.parentId?(r("parentId undefined"),!1):t.typeCode&&t.type!=e.kladr.type.city?(r('type must equal "city"'),!1):t.limit<1?(r("limit must greater than 0"),!1):!0},e.kladr.api=function(n,a){if(!a)return void r("Callback undefined");if(!e.kladr.validate(n))return void a([]);var i=e.Deferred();i.done(a),i.fail(function(e){r(e),a([])}),e.getJSON(e.kladr.url+"?callback=?",t(n),function(e){i.resolve(e.result||[])}),setTimeout(function(){i.reject("Request error")},3e3)},e.kladr.check=function(t,n){return n?(t.withParents=!1,t.limit=1,void e.kladr.api(t,function(e){n(e&&e.length?e[0]:!1)})):void r("Callback undefined")}}(jQuery),function(e,t){function n(n,r){function d(e,n){return e.isGet?s.get(e.str[0]):(s.set(e),n(),t)}var s=function(){var r=n.data("kladr-data");return r||(r=e.extend({},o,l),n.data("kladr-data",r)),{set:function(e){if(e.obj)for(var t in e.obj)i(e.obj,t)&&i(o,t)&&(r[t]=e.obj[t]);else e.str&&!e.isGet&&i(o,e.str[0])&&(r[e.str[0]]=e.str[1]);n.data("kladr-data",r)},get:function(e){return i(o,e)||i(l,e)?r[e]:t},_set:function(e,t){r[e]=t,n.data("kladr-data",r)},_get:function(e){return i(r,e)?r[e]:t}}}();return d(r,function(){function r(t){var r=e(document.getElementById("kladr_autocomplete"));r.length||(r=e('<div id="kladr_autocomplete"></div>').appendTo(document.body));var i=j("guid");i?(x=r.find(".autocomplete"+i),P=r.find(".spinner"+i),e(window).off(".kladr"),n.off(".kladr"),x.off(".kladr")):(i=a(),_("guid",i),n.attr("autocomplete","off"),x=e('<ul class="autocomplete'+i+' autocomplete" style="display: none;"></ul>').appendTo(r),P=e('<div class="spinner'+i+' spinner" style="display: none;"></div>').appendTo(r),y(),l(),h()),t()}function o(t,n){var r,a,o,l;x.empty();for(var u in t)i(t,u)&&(r=t[u],a=j("valueFormat")(r,n),o=j("labelFormat")(r,n),l=e('<a data-val="'+a+'">'+o+"</a>"),l.data("kladr-object",r),e("<li></li>").append(l).appendTo(x))}function l(){var e=n.offset(),t=n.outerWidth(),r=n.outerHeight();if(l.top!=e.top||l.left!=e.left||l.width!=t||l.height!=r){l.top=e.top,l.left=e.left,l.width=t,l.height=r,x.css({top:e.top+r+"px",left:e.left});var a=x.outerWidth()-x.width();x.width(t-a);var i=P.width(),o=P.height();P.css({top:e.top+(r-o)/2-1,left:e.left+t-i-2})}}function d(t){if(!(t.which>8&&t.which<46)){if(!g("open_before"))return void c();I(null);var r=n.val();if(!e.trim(r))return S(!1),void c();var a=w(r);if(!g("send_before",a))return void c();m(),g("send"),j("source")(a,function(t){return g("receive"),n.is(":focus")?e.trim(n.val())&&t.length?(o(t,a),l(),b(),x.slideDown(50),void g("open")):(b(),I(null),void c()):(b(),void c())})}}function c(){g("close_before")&&(x.empty().hide(),g("close"))}function f(e){var n=x.find("li.active");switch(e.which){case u.up:n.length?(n.removeClass("active"),n.prev().length&&(n=n.prev())):n=x.find("li").last(),function(){var e=x.scrollTop(),t=x.offset(),r=n.outerHeight(),a=n.offset();a.top-t.top<0&&x.scrollTop(e-r)}(),n.addClass("active"),v();break;case u.down:n.length?(n.removeClass("active"),n.next().length&&(n=n.next())):n=x.find("li").first(),function(){var e=x.scrollTop(),t=x.height(),r=x.offset(),a=n.outerHeight(),i=n.offset();i.top-r.top+a>t&&x.scrollTop(e+a)}(),n.addClass("active"),v();break;case u.enter:c()}return t}function p(){var t=e(this);return t.is("a")&&(t=t.parents("li")),t.addClass("active"),v(),c(),n.focus(),!1}function v(){if(g("select_before")){var e=x.find(".active a");e.length&&(n.val(e.attr("data-val")),S(!1),I(e.data("kladr-object")),g("select",j("current")))}}function k(){function t(e,t){S(t),I(e)}if(j("verify")&&g("check_before")){var r=e.trim(n.val());if(!r)return t(null,!1),void g("check",null);if(j("current"))return void S(!1);var a=w(r);if(a.withParents=!1,a.limit=10,!g("send_before",a))return t(null,!1),void g("check",null);m(),g("send"),j("source")(a,function(r){function o(e,n){b(),t(e,n)}if(g("receive"),!e.trim(n.val()))return void o(null,!1);var l=a.name.toLowerCase(),u=null,d=null;for(var s in r)if(i(r,s)&&(u=r[s].name.toLowerCase(),l==u)){d=r[s];break}d&&n.val(j("valueFormat")(d,a)),o(d,!d),g("check",d)})}}function y(){var t={setValue:function(r){function a(e,t){n.val(e?j("valueFormat")(e,t):""),I(e)}var o=w("");return"object"===e.type(r)?(a(r,o),t):"number"===e.type(r)?(o.parentType=o.type,o.parentId=r,o.limit=1,e.kladr.api(o,function(e){e.length&&a(e[0],o)}),t):"string"===e.type(r)&&(r=e.trim(r+""))?(o.name=T(r),o.withParents=!1,o.limit=10,g("send_before",o)?(g("send"),j("source")(o,function(e){g("receive");var t=o.name.toLowerCase(),n=null,r=null;for(var l in e)if(i(e,l)&&(n=e[l].name.toLowerCase(),t==n)){r=e[l];break}a(r,o)}),t):(a(null,o),t)):(a(null,null),t)},clear:function(){return t.setValue(null),t}};_("controller",t)}function h(){function e(){return n.val()?(k(),!!j("current")):!1}var t=0,r=e()||setInterval(function(){(++t>5||e())&&clearInterval(r)},100)}function g(t,r){if(!t)return!0;var a=t.replace(/_([a-z])/gi,function(e,t){return t.toUpperCase()});return n.trigger("kladr_"+t,r),"function"===e.type(j(a))?j(a).call(n.get(0),r)!==!1:!0}function m(){j("spinner")&&j("showSpinner")(P)}function b(){j("spinner")&&j("hideSpinner")(P)}function w(e){var t,n={token:j("token"),key:j("key"),type:j("type"),typeCode:j("typeCode"),name:T(e),parentType:j("parentType"),parentId:j("parentId"),oneString:j("oneString"),withParents:j("withParents"),limit:j("limit")},r=j("parentInput");return n.oneString&&(n.withParents=!0),r&&(t=C(r,n.type),t&&(n.parentType=t.type,n.parentId=t.id)),n}function C(t,n){var r,a=e.kladr.getInputs(t),o=e.kladr.type,l={},u=null;a.each(function(){var t,n=e(this);(t=n.attr("data-kladr-id"))&&(l[n.attr("data-kladr-type")]=t)});for(r in o){if(r==n)return u;i(o,r)&&l[r]&&(u={type:r,id:l[r]})}return u}function T(e){for(var t,n,r="abcdefghijklmnopqrstuvwxyz",a="Ёё",i="Ее",o=e.toLowerCase(),l="",u=0;u<o.length;u++){if(r.indexOf(o[u])>-1)return S(!0),e;t=e[u],n=a.indexOf(t),l+=n>-1?i[n]:t}return S(!1),l}function I(e){_("current",e),e&&e.id?n.attr("data-kladr-id",e.id):n.removeAttr("data-kladr-id"),j("oneString")&&e&&e.contentType&&n.attr("data-kladr-type",e.contentType)}function S(e){e?n.addClass("kladr-error"):n.removeClass("kladr-error")}function j(e){return s._get(e)}function _(e,t){s._set(e,t)}var x=null,P=null;r(function(){var t=!1;n.attr("data-kladr-type",j("type")||"").attr("data-kladr-one-string",j("oneString")||null).on("keyup.kladr",d).on("keydown.kladr",f).on("blur.kladr change.kladr",function(){t||(k(),c())}),x.on("touchstart.kladr click.kladr","li, a",function(){t=!0,p.call(this),t=!1}).on("mouseenter.kladr",function(){t=!0}).on("mouseleave.kladr",function(){t=!1}),e(window).on("resize.kladr",l)})})}function r(n){var r={obj:!1,str:!1,isGet:!1};if("object"===e.type(n))return r.obj=n,r;if("string"===e.type(n)){r.str=[];for(var a in arguments)i(arguments,a)&&(r.str[a]=arguments[a]);r.str[1]===t&&(r.isGet=!0)}return r}function a(){return a.guid||(a.guid=0),++a.guid}function i(e,t){return e.hasOwnProperty(t)}var o={token:null,key:null,type:null,typeCode:null,parentType:null,parentId:null,limit:10,oneString:!1,withParents:!1,parentInput:null,verify:!1,spinner:!0,open:null,close:null,send:null,receive:null,select:null,check:null,openBefore:null,closeBefore:null,sendBefore:null,selectBefore:null,checkBefore:null,source:function(t,n){e.kladr.api(t,n)},labelFormat:function(t,n){var r;if(n.oneString)return t.parents?(r=e.extend(!0,[],t.parents),r.push(t),e.kladr.buildAddress(r)):(t.typeShort?t.typeShort+". ":"")+t.name;var a,i,o,l,u="";return t.typeShort&&(u+=t.typeShort+". "),a=t.name,i=a.toLowerCase(),o=n.name.toLowerCase(),l=i.indexOf(o),l=l>0?l:0,o.length<i.length?(u+=a.substr(0,l),u+="<strong>"+a.substr(l,o.length)+"</strong>",u+=a.substr(l+o.length,i.length-o.length-l)):u+="<strong>"+a+"</strong>",u},valueFormat:function(t,n){var r;return n.oneString?t.parents?(r=e.extend(!0,[],t.parents),r.push(t),e.kladr.buildAddress(r)):(t.typeShort?t.typeShort+". ":"")+t.name:t.name},showSpinner:function(e){var t=-.2,n=setInterval(function(){return e.is(":visible")?(e.css("background-position","0% "+t+"%"),t+=5.555556,void(t>95&&(t=-.2))):(clearInterval(n),void(n=null))},30);e.show()},hideSpinner:function(e){e.hide()}},l={current:null,controller:null},u={up:38,down:40,enter:13};e.kladr=e.extend(e.kladr,{setDefault:function(e,t){var n=r(e,t);if(n.obj)for(var a in n.obj)i(o,a)&&(o[a]=n.obj[a]);else n.str&&!n.isGet&&i(o,n.str[0])&&(o[n.str[0]]=n.str[1])},getDefault:function(e){return i(o,e)?o[e]:t},getInputs:function(t){var n=e(),r="[data-kladr-type]";return e(t||document.body).each(function(){var t=e(this);n=n.add(t.is(r)?t:t.find(r))}),n},getAddress:function(t,n){var r,a=e.kladr.getInputs(t),o=e.kladr.type,l={},u={};a.each(function(){var t,n,r,a=e(this);if(a.attr("data-kladr-id"))if(t=a.kladr("current"),a.attr("data-kladr-one-string")&&t.parents){n=e.extend(!0,[],t.parents),n.push(t);for(r in n)i(n,r)&&(l[n[r].contentType]=n[r])}else l[a.attr("data-kladr-type")]=t;else l[a.attr("data-kladr-type")]=a.val()});for(r in o)i(o,r)&&l[r]&&(u[r]=l[r]);return(n||e.kladr.buildAddress)(u)},buildAddress:function(t){var n,r,a=[],o=!1,l="",u="",d="",s="";for(n in t)if(i(t,n)){if("object"===e.type(t[n])){for(o=!1,r=0;r<a.length;r++)if(a[r]==t[n].id){o=!0;break}if(o)continue;a.push(t[n].id),d=t[n].name,s=t[n].typeShort+". ",u=t[n].zip||u}else d=t[n],s="";l&&(l+=", "),l+=s+d}return l=(u?u+", ":"")+l}}),e.fn.kladr=function(a,i){var o=r(a,i),l=t;return this.each(function(){var r=n(e(this),o);return o.isGet?(l=r,!1):t}),o.isGet?l:this}}(jQuery),function(e){e.fn.kladrZip=function(t){var n=e(t||document.body);return this.keydown(function(t){var n=t.charCode||t.keyCode||0,r=8==n||9==n||13==n||46==n||110==n||190==n||n>=35&&40>=n||n>=96&&105>=n;return e(this).val().length>=6?r:r||n>=48&&57>=n}),this.keyup(function(){function t(e){e?r.addClass("kladr-error"):r.removeClass("kladr-error")}var r=e(this),a=r.val();return a?void e.kladr.api({type:e.kladr.type.building,zip:a,withParents:!0,limit:1},function(r){var a,i,o=r.length&&r[0];if(r=[],o){t(!1),o.parents&&(r=e.extend(!0,[],o.parents)),r.push(o);for(a in r)r.hasOwnProperty(a)&&(i=n.find('[data-kladr-type="'+r[a].contentType+'"]'),i.kladr("controller").setValue(r[a]))}else t(!0)}):void t(!1)}),this}}(jQuery);