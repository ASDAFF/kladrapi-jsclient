!function(t){function e(t){var e={},r={token:"token",key:"key",type:"contentType",name:"query",withParents:"withParent",limit:"limit"};t.parentType&&t.parentId&&(e[t.parentType+"Id"]=t.parentId);for(var n in t)t.hasOwnProperty(n)&&r.hasOwnProperty(n)&&t[n]&&(e[r[n]]=t[n]);return e}function r(t){window.console&&window.console.error&&window.console.error(t)}t.kladr={},t.kladr.url="http://kladr-api.ru/api.php",t.kladr.type={region:"region",district:"district",city:"city",street:"street",building:"building"},t.kladr.validate=function(e){switch(e.type){case t.kladr.type.region:case t.kladr.type.district:case t.kladr.type.city:if(e.parentType&&!e.parentId)return r("parentId undefined"),!1;break;case t.kladr.type.street:if(e.parentType!=t.kladr.type.city)return r('parentType must equal "city"'),!1;if(!e.parentId)return r("parentId undefined"),!1;break;case t.kladr.type.building:if(e.parentType!=t.kladr.type.street)return r('parentType must equal "street"'),!1;if(!e.parentId)return r("parentId undefined"),!1;break;default:return r("type incorrect"),!1}return e.limit<1?(r("limit must greater than 0"),!1):!0},t.kladr.api=function(n,a){if(!a)return void r("Callback undefined");if(!t.kladr.validate(n))return void a([]);var i=t.Deferred();i.done(a),i.fail(function(t){r(t),a([])}),t.getJSON(t.kladr.url+"?callback=?",e(n),function(t){i.resolve(t.result)}),setTimeout(function(){i.reject("Request error")},3e3)},t.kladr.check=function(e,n){return n?(e.withParents=!1,e.limit=1,void t.kladr.api(e,function(t){n(t&&t.length?t[0]:!1)})):void r("Callback undefined")}}(jQuery),function(t,e){function r(r,n){function u(t,r){return t.isGet?d.get(t.str[0]):(d.set(t),r(),e)}var d=function(){var n=r.data("kladr-data");return n||(n=t.extend({},i,o),r.data("kladr-data",n)),{set:function(t){if(t.obj)for(var e in t.obj)t.obj.hasOwnProperty(e)&&i.hasOwnProperty(e)&&(n[e]=t.obj[e]);else t.str&&!t.isGet&&i.hasOwnProperty(t.str[0])&&(n[t.str[0]]=t.str[1]);r.data("kladr-data",n)},get:function(t){return i.hasOwnProperty(t)||o.hasOwnProperty(t)?n[t]:e},_set:function(t,e){n[t]=e,r.data("kladr-data",n)},_get:function(t){return n.hasOwnProperty(t)?n[t]:e}}}();return u(n,function(){function n(e){var n=t(document.getElementById("kladr_autocomplete"));n.length||(n=t('<div id="kladr_autocomplete"></div>').appendTo(document.body));var i=T("guid");i?(O=n.find(".autocomplete"+i),j=n.find(".spinner"+i),r.off(".kladr"),O.off(".kladr")):(i=a(),I("guid",i),r.attr("autocomplete","off"),O=t('<ul class="autocomplete'+i+' autocomplete" style="display: none;"></ul>').appendTo(n),j=t('<div class="spinner'+i+' spinner" style="display: none;"></div>').appendTo(n),o()),e()}function i(e,r){var n,a,i,o;O.empty();for(var l in e)e.hasOwnProperty(l)&&(n=e[l],a=T("valueFormat")(n,r),i=T("labelFormat")(n,r),o=t('<a data-val="'+a+'">'+i+"</a>"),o.data("kladr-object",n),t("<li></li>").append(o).appendTo(O))}function o(){var t=r.offset(),e=r.outerWidth(),n=r.outerHeight();if(o.top!=t.top||o.left!=t.left||o.width!=e||o.height!=n){o.top=t.top,o.left=t.left,o.width=e,o.height=n,O.css({top:t.top+n+"px",left:t.left});var a=O.outerWidth()-O.width();O.width(e-a);var i=j.width(),l=j.height();j.css({top:t.top+(n-l)/2-1,left:t.left+e-i-2})}}function u(e){if(!(e.which>8&&e.which<46)){if(!h("open_before"))return void s();var n=r.val();if(!t.trim(n))return b(null),P(!1),void s();var a=g(n);if(!h("send_before",a))return void s();y(),h("send"),T("source")(a,function(e){return h("received"),r.is(":focus")?t.trim(r.val())&&e.length?(i(e,a),o(),k(),O.slideDown(50),void h("open")):(k(),b(null),void s()):(k(),void s())})}}function s(){h("close_before")&&(O.empty().hide(),h("close"))}function c(t){var r=O.find("li.active");switch(t.which){case l.up:r.length?(r.removeClass("active"),r.prev().length&&(r=r.prev())):r=O.find("li").last(),function(){var t=O.scrollTop(),e=O.offset(),n=r.outerHeight(),a=r.offset();a.top-e.top<0&&O.scrollTop(t-n)}(),r.addClass("active"),p();break;case l.down:r.length?(r.removeClass("active"),r.next().length&&(r=r.next())):r=O.find("li").first(),function(){var t=O.scrollTop(),e=O.height(),n=O.offset(),a=r.outerHeight(),i=r.offset();i.top-n.top+a>e&&O.scrollTop(t+a)}(),r.addClass("active"),p();break;case l.enter:s()}return e}function f(){var e=t(this);return e.is("a")&&(e=e.parents("li")),e.addClass("active"),p(),s(),r.focus(),!1}function p(){if(h("select_before")){var t=O.find(".active a");t.length&&(r.val(t.attr("data-val")),P(!1),b(t.data("kladr-object")),h("select",T("current")))}}function v(){function e(t,e){P(e),b(t)}if(T("verify")&&h("check_before")){var n=t.trim(r.val());if(!n)return void e(null,!1);var a=g(n);if(a.withParents=!1,a.limit=10,!h("send_before",a))return e(null,!1),void h("check",null);y(),h("send"),T("source")(a,function(n){function i(t,r){k(),e(t,r)}if(h("received"),!t.trim(r.val()))return void i(null,!1);var o=a.name.toLowerCase(),l=null,u=null;for(var d in n)if(n.hasOwnProperty(d)&&(l=n[d].name.toLowerCase(),o==l)){u=n[d];break}u&&r.val(T("valueFormat")(u,a)),i(u,!u),h("check",u)})}}function h(e,n){if(!e)return!0;var a=e.replace(/_([a-z])/gi,function(t,e){return e.toUpperCase()});return r.trigger("kladr_"+e,n),"function"===t.type(T(a))?T(a).call(r.get(0),n):!0}function y(){T("spinner")&&T("showSpinner")(j)}function k(){T("spinner")&&T("hideSpinner")(j)}function g(t){var e,r={token:T("token"),key:T("key"),type:T("type"),name:w(t),parentType:T("parentType"),parentId:T("parentId"),withParents:T("withParents"),limit:T("limit")},n=T("parentInput");return n&&(e=m(n,r.type),e&&(r.parentType=e.type,r.parentId=e.id)),r}function m(e,r){var n,a=t.kladr.getInputs(e),i=t.kladr.getTypes(),o={},l=null;a.each(function(){var e,r=t(this);(e=r.attr("data-kladr-id"))&&(o[r.attr("data-kladr-type")]=e)});for(n in i){if(n==r)return l;i.hasOwnProperty(n)&&o[n]&&(l={type:n,id:o[n]})}return l}function w(t){for(var e,r,n="abcdefghijklmnopqrstuvwxyz",a="Ёё",i="Ее",o=t.toLowerCase(),l="",u=0;u<o.length;u++){if(n.indexOf(o[u])>-1)return P(!0),t;e=t[u],r=a.indexOf(e),l+=r>-1?i[r]:e}return P(!1),l}function b(t){I("current",t),t&&t.id?r.attr("data-kladr-id",t.id):r.removeAttr("data-kladr-id")}function P(t){t?r.addClass("kladr-error"):r.removeClass("kladr-error")}function T(t){return d._get(t)}function I(t,e){d._set(t,e)}var O=null,j=null;n(function(){var t=!1;r.attr("data-kladr-type",T("type")).on("keyup.kladr",u).on("keydown.kladr",c).on("blur.kladr",function(){v(),t||s()}),O.on("touchstart.kladr click.kladr","li, a",f).on("touchstart.kladr mouseenter.kladr","li",function(){t=!0}).on("touchend.kladr mouseleave.kladr","li",function(){t=!1})})})}function n(r){var n={obj:!1,str:!1,isGet:!1};if("object"===t.type(r))return n.obj=r,n;if("string"===t.type(r)){n.str=[];for(var a in arguments)arguments.hasOwnProperty(a)&&(n.str[a]=arguments[a]);n.str[1]===e&&(n.isGet=!0)}return n}function a(){return a.guid||(a.guid=0),++a.guid}var i={token:null,key:null,type:null,parentType:null,parentId:null,limit:10,withParents:!1,parentInput:null,verify:!1,spinner:!0,open:null,close:null,send:null,received:null,select:null,check:null,openBefore:null,closeBefore:null,sendBefore:null,selectBefore:null,checkBefore:null,source:function(e,r){t.kladr.api(e,r)},labelFormat:function(t,e){var r="",n=t.name.toLowerCase(),a=e.name.toLowerCase(),i=n.indexOf(a);return i=i>0?i:0,t.typeShort&&(r+=t.typeShort+". "),a.length<n.length?(r+=t.name.substr(0,i),r+="<strong>"+t.name.substr(i,a.length)+"</strong>",r+=t.name.substr(i+a.length,n.length-a.length-i)):r+="<strong>"+t.name+"</strong>",r},valueFormat:function(t){return t.name},showSpinner:function(t){var e=-.2,r=setInterval(function(){return t.is(":visible")?(t.css("background-position","0% "+e+"%"),e+=5.555556,void(e>95&&(e=-.2))):(clearInterval(r),void(r=null))},30);t.show()},hideSpinner:function(t){t.hide()}},o={current:null},l={up:38,down:40,enter:13};t.kladr=t.extend(t.kladr,{setDefault:function(t,e){var r=n(t,e);if(r.obj)for(var a in r.obj)i.hasOwnProperty(a)&&(i[a]=r.obj[a]);else r.str&&!r.isGet&&i.hasOwnProperty(r.str[0])&&(i[r.str[0]]=r.str[1])},getDefault:function(t){return i.hasOwnProperty(t)?i[t]:e},getTypes:function(){return t.kladr.type},getInputs:function(e){var r=t(),n="[data-kladr-type]";return t(e||document.body).each(function(){var e=t(this);r=r.add(e.is(n)?e:e.find(n))}),r},getAddress:function(e,r){var n,a=t.kladr.getInputs(e),i=t.kladr.getTypes(),o={},l={};r=r||function(e){var r="",n="",a="",i="";for(var o in e)e.hasOwnProperty(o)&&("object"===t.type(e[o])?(a=e[o].name,i=e[o].typeShort+". ",n=e[o].zip||n):(a=e[o],i=""),r&&(r+=", "),r+=i+a);return r=(n?n+", ":"")+r},a.each(function(){var e=t(this);o[e.attr("data-kladr-type")]=e.attr("data-kladr-id")?e.kladr("current"):e.val()});for(n in i)i.hasOwnProperty(n)&&o[n]&&(l[n]=o[n]);return r(l)}}),t.fn.kladr=function(a,i){var o=n(a,i),l=e;return this.each(function(){var n=r(t(this),o);return o.isGet?(l=n,!1):e}),o.isGet?l:this}}(jQuery);