!function(e){e.kladr={},e.kladr.url="http://kladr-api.ru/api.php",e.kladr.type={region:"region",district:"district",city:"city",street:"street",building:"building"},e.kladr.api=function(t,r){var n={};t.token&&(n.token=t.token),t.key&&(n.key=t.key),t.type&&(n.contentType=t.type),t.name&&(n.query=t.name),t.parentType&&t.parentId&&(n[t.parentType+"Id"]=t.parentId),t.withParents&&(n.withParent=1),n.limit=t.limit?t.limit:2e3;var a=!1;e.getJSON(e.kladr.url+"?callback=?",n,function(e){a||(a=!0,r&&r(e.result))}),setTimeout(function(){a||(a=!0,console.error("Request error"),r&&r([]))},5e3)},e.kladr.check=function(t,r){t.withParents=!1,t.limit=1,e.kladr.api(t,function(e){e&&e.length?r&&r(e[0]):r&&r(!1)})}}(jQuery),function(e,t){e.fn.kladr=function(r,n){function a(r,n,a){function i(n,a,i){if(I=r.data("kladr-options"),a!==t)return I[n]=a,r.data("kladr-options",I),r;if("string"===e.type(n))return I?I[n]:null;if(I)return r;if(I=C,"object"===e.type(n))for(var o in n)I[o]=n[o];return r.data("kladr-options",I),i&&i(),r}function o(){var t=e(document.getElementById("kladr_autocomplete")),n=r.attr("name");t.length||(t=e('<div id="kladr_autocomplete"></div>').appendTo("body")),r.attr("autocomplete","off"),b=e('<ul class="kladr_autocomplete_'+n+'" style="display: none;"></ul>'),b.appendTo(t),T=e('<div class="spinner kladr_autocomplete_'+n+'_spinner" class="spinner" style="display: none;"></div>'),T.appendTo(t)}function l(t,r){b.empty();for(var n in t){var a=t[n],i=I.valueFormat(a,r),o=I.labelFormat(a,r),l=e('<a data-val="'+i+'">'+o+"</a>");l.data("kladr-object",a);var c=e("<li></li>").append(l);c.appendTo(b)}}function c(){var e=r.offset(),t=r.outerWidth(),n=r.outerHeight();b.css({top:e.top+n+"px",left:e.left});var a=b.outerWidth()-b.width();b.width(t-a);var i=T.width(),o=T.height();T.css({top:e.top+(n-o)/2-1,left:e.left+t-i-2})}function u(t){if(!(t.which>8&&t.which<46)&&d()){var n=h(r.val());if(!e.trim(n))return void s();g(),y("send"),I.source(n,function(t){return w(),y("received"),r.is(":focus")&&e.trim(r.val())&&t.length?(l(t,n),c(),b.slideDown(50),void y("open")):void s()})}}function s(){p(),b.hide(),y("close")}function d(){switch(I.type){case e.kladr.type.region:case e.kladr.type.district:case e.kladr.type.city:if(I.parentType&&!I.parentId)return console.error("parentType is defined and parentId in not"),!1;break;case e.kladr.type.street:if(I.parentType!=e.kladr.type.city)return console.error('For street parentType must equal "city"'),!1;if(!I.parentId)return console.error("For street parentId must defined"),!1;break;case e.kladr.type.building:if(I.parentType!=e.kladr.type.street)return console.error('For building parentType must equal "street"'),!1;if(!I.parentId)return console.error("For building parentId must defined"),!1;break;default:return console.error('type must defined and equal "region", "district", "city", "street" or "building"'),!1}return I.limit<1?(console.error("limit must greater than 0"),!1):!0}function p(){var e=b.find(".active a");e.length&&(r.val(e.attr("data-val")),I.current=e.data("kladr-object"),r.data("kladr-options",I),y("select",I.current))}function f(e){var t=b.find("li.active");switch(e.which){case F.up:t.length?(t.removeClass("active"),t=t.prev()):t=b.find("li").last(),t.addClass("active");var r=t.find("a").data("kladr-object");y("preselect",r),I.arrowSelect&&p();break;case F.down:t.length?(t.removeClass("active"),t=t.next()):t=b.find("li").first(),t.addClass("active");var r=t.find("a").data("kladr-object");y("preselect",r),I.arrowSelect&&p();break;case F.esc:t.removeClass("active"),s();break;case F.enter:return I.arrowSelect||p(),t.removeClass("active"),s(),!1}}function v(){return s(),r.focus(),!1}function k(){if(I.verify){if(!d())return I.current=null,r.data("kladr-options",I),void y("check",I.current);var t=h(r.val());if(!e.trim(t))return I.current=null,r.data("kladr-options",I),void y("check",I.current);g(),y("send"),I.source(t,function(e){w(),y("received");for(var n=null,a=0;a<e.length;a++){var i=t.toLowerCase(),o=e[a].name.toLowerCase();if(i==o){n=e[a];break}}n&&r.val(I.valueFormat(n,t)),I.current=n,r.data("kladr-options",I),y("check",I.current)})}}function h(e){for(var t,r,n="1234567890qazwsxedcrfvtgbyhnujmik,ol.p;[']- QAZWSXEDCRFVTGBYHNUJMIK<OL>P:{\"} ",a="1234567890йфяцычувскамепинртгоьшлбщдюзжхэъ- ЙФЯЦЫЧУВСКАМЕПИНРТГОЬШЛБЩДЮЗЖХЭЪ ",i="",o=0;o<e.length;o++)t=e[o],r=n.indexOf(t),i+=r>-1?a[r]:t;return i}function y(e,t){e&&(r.trigger("kladr_"+e,t),I[e]&&I[e].call(r.get(0),t))}function m(){if(!S){var e=-.2;S=setInterval(function(){return T.is(":visible")?(T.css("background-position","0% "+e+"%"),e+=5.555556,void(e>95&&(e=-.2))):(clearInterval(S),void(S=null))},30)}}function g(){I.showSpinner&&(T.show(),m())}function w(){T.hide()}var b=null,T=null,I=null,C={token:null,key:null,type:null,parentType:null,parentId:null,limit:10,withParents:!1,verify:!1,showSpinner:!0,arrowSelect:!0,current:null,open:null,close:null,send:null,received:null,select:null,check:null,source:function(t,r){var n={token:I.token,key:I.token,type:I.type,name:t,parentType:I.parentType,parentId:I.parentId,withParents:I.withParents,limit:I.limit};e.kladr.api(n,r)},labelFormat:function(e,t){var r="",n=e.name.toLowerCase();t=t.toLowerCase();var a=n.indexOf(t);return a=a>0?a:0,e.typeShort&&(r+=e.typeShort+". "),t.length<e.name.length?(r+=e.name.substr(0,a),r+="<strong>"+e.name.substr(a,t.length)+"</strong>",r+=e.name.substr(a+t.length,e.name.length-t.length-a)):r+="<strong>"+e.name+"</strong>",r},valueFormat:function(e){return e.name}},F={up:38,down:40,esc:27,enter:13},S=null;return i(n,a,function(){var t=!1;o(),c(),r.on("keyup",u).on("keydown",f).on("change",function(){t||k()}).on("blur",function(){t||s()}),b.on("click","li, a",v).on("touchstart mouseenter","li",function(){var r=e(this);b.find("li.active").removeClass("active"),r.addClass("active");var n=r.find("a").data("kladr-object");y("preselect",n),t=!0}).on("touchleave mouseleave","li",function(){e(this).removeClass("active"),t=!1}),e(window).on("resize",c)})}var i=t;return this.each(function(){var o=a(e(this),r,n);i==t&&(i=o)}),i}}(jQuery);