!function(t){function e(t){var e={},r={token:"token",key:"key",type:"contentType",typeCode:"typeCode",name:"query",zip:"zip",withParents:"withParent",oneString:"oneString",limit:"limit"};t.parentType&&t.parentId&&(e[t.parentType+"Id"]=t.parentId);for(var a in t)n(t,a)&&n(r,a)&&t[a]&&(e[r[a]]=t[a]);return e}function n(t,e){return t.hasOwnProperty(e)}function r(t){window.console&&window.console.error&&window.console.error(t)}t.kladr={},t.kladr.url="http://kladr-api.ru/api.php",t.kladr.type={region:"region",district:"district",city:"city",street:"street",building:"building"},t.kladr.typeCode={city:1,settlement:2,village:4},t.kladr.validate=function(e){switch(e.type){case t.kladr.type.region:case t.kladr.type.district:case t.kladr.type.city:if(e.parentType&&!e.parentId)return r("parentId undefined"),!1;break;case t.kladr.type.street:if(e.parentType!=t.kladr.type.city)return r('parentType must equal "city"'),!1;if(!e.parentId)return r("parentId undefined"),!1;break;case t.kladr.type.building:if(!e.zip){if(e.parentType!=t.kladr.type.street)return r('parentType must equal "street"'),!1;if(!e.parentId)return r("parentId undefined"),!1}break;default:if(!e.oneString)return r("type incorrect"),!1}return e.oneString&&e.parentType&&!e.parentId?(r("parentId undefined"),!1):e.typeCode&&e.type!=t.kladr.type.city?(r('type must equal "city"'),!1):e.limit<1?(r("limit must greater than 0"),!1):!0},t.kladr.api=function(n,a){if(!a)return void r("Callback undefined");if(!t.kladr.validate(n))return void a([]);var i=t.Deferred();i.done(a),i.fail(function(t){r(t),a([])}),t.getJSON(t.kladr.url+"?callback=?",e(n),function(t){i.resolve(t.result||[])}),setTimeout(function(){i.reject("Request error")},3e3)},t.kladr.check=function(e,n){return n?(e.withParents=!1,e.limit=1,void t.kladr.api(e,function(t){n(t&&t.length?t[0]:!1)})):void r("Callback undefined")}}(jQuery),function(t,e){function n(n,r){function u(t,n){return t.isGet?s.get(t.str[0]):(s.set(t),n(),e)}var s=function(){var r=n.data("kladr-data");return r||(r=t.extend({},o,l),n.data("kladr-data",r)),{set:function(t){if(t.obj)for(var e in t.obj)i(t.obj,e)&&i(o,e)&&(r[e]=t.obj[e]);else t.str&&!t.isGet&&i(o,t.str[0])&&(r[t.str[0]]=t.str[1]);n.data("kladr-data",r)},get:function(t){return i(o,t)||i(l,t)?r[t]:e},_set:function(t,e){r[t]=e,n.data("kladr-data",r)},_get:function(t){return i(r,t)?r[t]:e}}}();return u(r,function(){function r(e){var r=t(document.getElementById("kladr_autocomplete"));r.length||(r=t('<div id="kladr_autocomplete"></div>').appendTo(document.body));var i=S("guid");i?(_=r.find(".autocomplete"+i),x=r.find(".spinner"+i),n.off(".kladr"),_.off(".kladr")):(i=a(),j("guid",i),n.attr("autocomplete","off"),_=t('<ul class="autocomplete'+i+' autocomplete" style="display: none;"></ul>').appendTo(r),x=t('<div class="spinner'+i+' spinner" style="display: none;"></div>').appendTo(r),l(),h()),e()}function o(e,n){var r,a,o,l;_.empty();for(var d in e)i(e,d)&&(r=e[d],a=S("valueFormat")(r,n),o=S("labelFormat")(r,n),l=t('<a data-val="'+a+'">'+o+"</a>"),l.data("kladr-object",r),t("<li></li>").append(l).appendTo(_))}function l(){var t=n.offset(),e=n.outerWidth(),r=n.outerHeight();if(l.top!=t.top||l.left!=t.left||l.width!=e||l.height!=r){l.top=t.top,l.left=t.left,l.width=e,l.height=r,_.css({top:t.top+r+"px",left:t.left});var a=_.outerWidth()-_.width();_.width(e-a);var i=x.width(),o=x.height();x.css({top:t.top+(r-o)/2-1,left:t.left+e-i-2})}}function u(e){if(!(e.which>8&&e.which<46)){if(!y("open_before"))return void c();T(null);var r=n.val();if(!t.trim(r))return I(!1),void c();var a=b(r);if(!y("send_before",a))return void c();g(),y("send"),S("source")(a,function(e){return y("receive"),n.is(":focus")?t.trim(n.val())&&e.length?(o(e,a),l(),m(),_.slideDown(50),void y("open")):(m(),T(null),void c()):(m(),void c())})}}function c(){y("close_before")&&(_.empty().hide(),y("close"))}function f(t){var n=_.find("li.active");switch(t.which){case d.up:n.length?(n.removeClass("active"),n.prev().length&&(n=n.prev())):n=_.find("li").last(),function(){var t=_.scrollTop(),e=_.offset(),r=n.outerHeight(),a=n.offset();a.top-e.top<0&&_.scrollTop(t-r)}(),n.addClass("active"),v();break;case d.down:n.length?(n.removeClass("active"),n.next().length&&(n=n.next())):n=_.find("li").first(),function(){var t=_.scrollTop(),e=_.height(),r=_.offset(),a=n.outerHeight(),i=n.offset();i.top-r.top+a>e&&_.scrollTop(t+a)}(),n.addClass("active"),v();break;case d.enter:c()}return e}function p(){var e=t(this);return e.is("a")&&(e=e.parents("li")),e.addClass("active"),v(),c(),n.focus(),!1}function v(){if(y("select_before")){var t=_.find(".active a");t.length&&(n.val(t.attr("data-val")),I(!1),T(t.data("kladr-object")),y("select",S("current")))}}function k(){function e(t,e){I(e),T(t)}if(S("verify")&&y("check_before")){if(S("current"))return void I(!1);var r=t.trim(n.val());if(!r)return e(null,!1),void y("check",null);var a=b(r);if(a.withParents=!1,a.limit=10,!y("send_before",a))return e(null,!1),void y("check",null);g(),y("send"),S("source")(a,function(r){function o(t,n){m(),e(t,n)}if(y("receive"),!t.trim(n.val()))return void o(null,!1);var l=a.name.toLowerCase(),d=null,u=null;for(var s in r)if(i(r,s)&&(d=r[s].name.toLowerCase(),l==d)){u=r[s];break}u&&n.val(S("valueFormat")(u,a)),o(u,!u),y("check",u)})}}function h(){function t(){return n.val()?(k(),!!S("current")):!1}var e=0,r=t()||setInterval(function(){(++e>5||t())&&clearInterval(r)},100)}function y(e,r){if(!e)return!0;var a=e.replace(/_([a-z])/gi,function(t,e){return e.toUpperCase()});return n.trigger("kladr_"+e,r),"function"===t.type(S(a))?S(a).call(n.get(0),r)!==!1:!0}function g(){S("spinner")&&S("showSpinner")(x)}function m(){S("spinner")&&S("hideSpinner")(x)}function b(t){var e,n={token:S("token"),key:S("key"),type:S("type"),typeCode:S("typeCode"),name:C(t),parentType:S("parentType"),parentId:S("parentId"),oneString:S("oneString"),withParents:S("withParents"),limit:S("limit")},r=S("parentInput");return n.oneString&&(n.withParents=!0),r&&(e=w(r,n.type),e&&(n.parentType=e.type,n.parentId=e.id)),n}function w(e,n){var r,a=t.kladr.getInputs(e),o=t.kladr.type,l={},d=null;a.each(function(){var e,n=t(this);(e=n.attr("data-kladr-id"))&&(l[n.attr("data-kladr-type")]=e)});for(r in o){if(r==n)return d;i(o,r)&&l[r]&&(d={type:r,id:l[r]})}return d}function C(t){for(var e,n,r="abcdefghijklmnopqrstuvwxyz",a="Ёё",i="Ее",o=t.toLowerCase(),l="",d=0;d<o.length;d++){if(r.indexOf(o[d])>-1)return I(!0),t;e=t[d],n=a.indexOf(e),l+=n>-1?i[n]:e}return I(!1),l}function T(t){j("current",t),t&&t.id?n.attr("data-kladr-id",t.id):n.removeAttr("data-kladr-id"),S("oneString")&&t&&t.contentType&&n.attr("data-kladr-type",t.contentType)}function I(t){t?n.addClass("kladr-error"):n.removeClass("kladr-error")}function S(t){return s._get(t)}function j(t,e){s._set(t,e)}var _=null,x=null;r(function(){var e=!1;n.attr("data-kladr-type",S("type")||"").attr("data-kladr-one-string",S("oneString")||null).on("keyup.kladr",u).on("keydown.kladr",f).on("blur.kladr",function(){e||(k(),c())}),_.on("touchstart.kladr click.kladr","li, a",function(){e=!0,p.call(this),e=!1}).on("mouseenter.kladr",function(){e=!0}).on("mouseleave.kladr",function(){e=!1}),t(window).on("resize.kladr",l)})})}function r(n){var r={obj:!1,str:!1,isGet:!1};if("object"===t.type(n))return r.obj=n,r;if("string"===t.type(n)){r.str=[];for(var a in arguments)i(arguments,a)&&(r.str[a]=arguments[a]);r.str[1]===e&&(r.isGet=!0)}return r}function a(){return a.guid||(a.guid=0),++a.guid}function i(t,e){return t.hasOwnProperty(e)}var o={token:null,key:null,type:null,typeCode:null,parentType:null,parentId:null,limit:10,oneString:!1,withParents:!1,parentInput:null,verify:!1,spinner:!0,open:null,close:null,send:null,receive:null,select:null,check:null,openBefore:null,closeBefore:null,sendBefore:null,selectBefore:null,checkBefore:null,source:function(e,n){t.kladr.api(e,n)},labelFormat:function(e,n){var r;if(n.oneString)return e.parents?(r=t.extend(!0,[],e.parents),r.push(e),t.kladr.buildAddress(r)):(e.typeShort?e.typeShort+". ":"")+e.name;var a,i,o,l,d="";return e.typeShort&&(d+=e.typeShort+". "),a=e.name,i=a.toLowerCase(),o=n.name.toLowerCase(),l=i.indexOf(o),l=l>0?l:0,o.length<i.length?(d+=a.substr(0,l),d+="<strong>"+a.substr(l,o.length)+"</strong>",d+=a.substr(l+o.length,i.length-o.length-l)):d+="<strong>"+a+"</strong>",d},valueFormat:function(e,n){var r;return n.oneString?e.parents?(r=t.extend(!0,[],e.parents),r.push(e),t.kladr.buildAddress(r)):(e.typeShort?e.typeShort+". ":"")+e.name:e.name},showSpinner:function(t){var e=-.2,n=setInterval(function(){return t.is(":visible")?(t.css("background-position","0% "+e+"%"),e+=5.555556,void(e>95&&(e=-.2))):(clearInterval(n),void(n=null))},30);t.show()},hideSpinner:function(t){t.hide()}},l={current:null},d={up:38,down:40,enter:13};t.kladr=t.extend(t.kladr,{setDefault:function(t,e){var n=r(t,e);if(n.obj)for(var a in n.obj)i(o,a)&&(o[a]=n.obj[a]);else n.str&&!n.isGet&&i(o,n.str[0])&&(o[n.str[0]]=n.str[1])},getDefault:function(t){return i(o,t)?o[t]:e},getInputs:function(e){var n=t(),r="[data-kladr-type]";return t(e||document.body).each(function(){var e=t(this);n=n.add(e.is(r)?e:e.find(r))}),n},getAddress:function(e,n){var r,a=t.kladr.getInputs(e),o=t.kladr.type,l={},d={};a.each(function(){var e,n,r,a=t(this);if(a.attr("data-kladr-id"))if(e=a.kladr("current"),a.attr("data-kladr-one-string")&&e.parents){n=t.extend(!0,[],e.parents),n.push(e);for(r in n)i(n,r)&&(l[n[r].contentType]=n[r])}else l[a.attr("data-kladr-type")]=e;else l[a.attr("data-kladr-type")]=a.val()});for(r in o)i(o,r)&&l[r]&&(d[r]=l[r]);return(n||t.kladr.buildAddress)(d)},buildAddress:function(e){var n,r,a=[],o=!1,l="",d="",u="",s="";for(n in e)if(i(e,n)){if("object"===t.type(e[n])){for(o=!1,r=0;r<a.length;r++)if(a[r]==e[n].id){o=!0;break}if(o)continue;a.push(e[n].id),u=e[n].name,s=e[n].typeShort+". ",d=e[n].zip||d}else u=e[n],s="";l&&(l+=", "),l+=s+u}return l=(d?d+", ":"")+l}}),t.fn.kladr=function(a,i){var o=r(a,i),l=e;return this.each(function(){var r=n(t(this),o);return o.isGet?(l=r,!1):e}),o.isGet?l:this}}(jQuery),function(t){t.fn.kladrZip=function(e){var n=t(e||document.body);return this.keydown(function(e){var n=e.charCode||e.keyCode||0,r=8==n||9==n||13==n||46==n||110==n||190==n||n>=35&&40>=n||n>=96&&105>=n;return t(this).val().length>=6?r:r||n>=48&&57>=n}),this.keyup(function(){function e(t){t?r.addClass("kladr-error"):r.removeClass("kladr-error")}var r=t(this),a=r.val();return a?void t.kladr.api({type:t.kladr.type.building,zip:a,withParents:!0,limit:1},function(r){var a,i,o,l=r.length&&r[0];if(r=[],l){e(!1),l.parents&&(r=t.extend(!0,[],l.parents)),r.push(l);for(a in r)r.hasOwnProperty(a)&&(i=n.find('[data-kladr-type="'+r[a].contentType+'"]'),o=i.kladr("source"),function(){var t=r[a];i.val(t.name).kladr("source",function(e,n){n([t])})}(),i.trigger("blur"),i.kladr("source",o))}else e(!0)}):void e(!1)}),this}}(jQuery);