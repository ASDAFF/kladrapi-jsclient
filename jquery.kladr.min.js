(function(a){a.kladr={};a.kladr.url="http://kladr-api.ru/api.php";a.kladr.type={region:"region",district:"district",city:"city",street:"street",building:"building"};a.kladr.api=function(c,e){var d={};if(c.token){d.token=c.token}if(c.key){d.key=c.key}if(c.type){d.contentType=c.type}if(c.name){d.query=c.name}if(c.parentType&&c.parentId){d[c.parentType+"Id"]=c.parentId}if(c.withParents){d.withParent=1}d.limit=c.limit?c.limit:2000;var b=false;a.getJSON(a.kladr.url+"?callback=?",d,function(f){if(b){return}b=true;e&&e(f.result)});setTimeout(function(){if(b){return}b=true;console.error("Request error");e&&e([])},5000)};a.kladr.check=function(b,c){b.withParents=false;b.limit=1;a.kladr.api(b,function(d){if(d&&d.length){c&&c(d[0])}else{c&&c(false)}})}})(jQuery);(function(a,b){a.fn.kladr=function(f,e){var c=b;this.each(function(){var g=d(a(this),f,e);if(c==b){c=g}});return c;function d(p,l,k){var A=null;var j=null;var i=null;var z={token:null,key:null,type:null,parentType:null,parentId:null,limit:10,withParents:false,verify:false,showSpinner:true,arrowSelect:true,current:null,open:null,close:null,send:null,received:null,select:null,check:null,source:function(F,H){var G={token:i.token,key:i.token,type:i.type,name:F,parentType:i.parentType,parentId:i.parentId,withParents:i.withParents,limit:i.limit};a.kladr.api(G,H)},labelFormat:function(I,H){var G="";var F=I.name.toLowerCase();H=H.toLowerCase();var J=F.indexOf(H);J=J>0?J:0;if(I.typeShort){G+=I.typeShort+". "}if(H.length<I.name.length){G+=I.name.substr(0,J);G+="<strong>"+I.name.substr(J,H.length)+"</strong>";G+=I.name.substr(J+H.length,I.name.length-H.length-J)}else{G+="<strong>"+I.name+"</strong>"}return G},valueFormat:function(G,F){return G.name}};var s={up:38,down:40,esc:27,enter:13};var g=null;return y(l,k,function(){var F=false;o();B();p.keyup(q);p.keydown(x);p.change(function(){if(!F){n()}});p.blur(function(){if(!F){u()}});A.on("click","li, a",h);A.on("mouseenter","li",function(){var H=a(this);A.find("li.active").removeClass("active");H.addClass("active");var G=H.find("a").data("kladr-object");t("preselect",G);F=true});A.on("mouseleave","li",function(){a(this).removeClass("active");F=false});a(window).resize(B)});function y(H,G,I){i=p.data("kladr-options");if(G!==b){i[H]=G;p.data("kladr-options",i);return p}if(a.type(H)==="string"){if(!i){return null}return i[H]}if(i){return p}i=z;if(a.type(H)==="object"){for(var F in H){i[F]=H[F]}}p.data("kladr-options",i);I&&I();return p}function o(){var F=a(document.getElementById("kladr_autocomplete"));var G=p.attr("name");if(!F.length){F=a('<div id="kladr_autocomplete"></div>').appendTo("body")}p.attr("autocomplete","off");A=a('<ul class="kladr_autocomplete_'+G+'" style="display: none;"></ul>');A.appendTo(F);j=a('<div class="spinner kladr_autocomplete_'+G+'_spinner" class="spinner" style="display: none;"></div>');j.appendTo(F)}function C(M,K){A.empty();for(var I in M){var L=M[I];var J=i.valueFormat(L,K);var H=i.labelFormat(L,K);var G=a('<a data-val="'+J+'">'+H+"</a>");G.data("kladr-object",L);var F=a("<li></li>").append(G);F.appendTo(A)}}function B(){var H=p.offset();var J=p.outerWidth();var I=p.outerHeight();A.css({top:H.top+I+"px",left:H.left});var G=A.outerWidth()-A.width();A.width(J-G);var K=j.width();var F=j.height();j.css({top:H.top+(I-F)/2-1,left:H.left+J-K-2})}function q(F){if((F.which>8)&&(F.which<46)){return}if(!v()){return}var G=E(p.val());if(!a.trim(G)){u();return}D();t("send");i.source(G,function(H){r();t("received");if(!p.is(":focus")){u();return}if(!a.trim(p.val())||!H.length){u();return}C(H,G);B();A.slideDown(50);t("open")})}function u(){w();A.hide();t("close")}function v(){switch(i.type){case a.kladr.type.region:case a.kladr.type.district:case a.kladr.type.city:if(i.parentType&&!i.parentId){console.error("parentType is defined and parentId in not");return false}break;case a.kladr.type.street:if(i.parentType!=a.kladr.type.city){console.error('For street parentType must equal "city"');return false}if(!i.parentId){console.error("For street parentId must defined");return false}break;case a.kladr.type.building:if(i.parentType!=a.kladr.type.street){console.error('For building parentType must equal "street"');return false}if(!i.parentId){console.error("For building parentId must defined");return false}break;default:console.error('type must defined and equal "region", "district", "city", "street" or "building"');return false}if(i.limit<1){console.error("limit must greater than 0");return false}return true}function w(){var F=A.find(".active a");if(!F.length){return}p.val(F.attr("data-val"));i.current=F.data("kladr-object");p.data("kladr-options",i);t("select",i.current)}function x(F){var H=A.find("li.active");switch(F.which){case s.up:if(H.length){H.removeClass("active");H=H.prev()}else{H=A.find("li").last()}H.addClass("active");var G=H.find("a").data("kladr-object");t("preselect",G);if(i.arrowSelect){w()}break;case s.down:if(H.length){H.removeClass("active");H=H.next()}else{H=A.find("li").first()}H.addClass("active");var G=H.find("a").data("kladr-object");t("preselect",G);if(i.arrowSelect){w()}break;case s.esc:H.removeClass("active");u();break;case s.enter:if(!i.arrowSelect){w()}H.removeClass("active");u();return false}}function h(){u();p.focus();return false}function n(){if(!i.verify){return}if(!v()){i.current=null;p.data("kladr-options",i);t("check",i.current);return}var F=E(p.val());if(!a.trim(F)){i.current=null;p.data("kladr-options",i);t("check",i.current);return}D();t("send");i.source(F,function(K){r();t("received");var J=null;for(var H=0;H<K.length;H++){var G=F.toLowerCase();var I=K[H].name.toLowerCase();if(G==I){J=K[H];break}}if(J){p.val(i.valueFormat(J,F))}i.current=J;p.data("kladr-options",i);t("check",i.current)})}function E(L){var I="1234567890qazwsxedcrfvtgbyhnujmik,ol.p;[']- QAZWSXEDCRFVTGBYHNUJMIK<OL>P:{\"} ";var G="1234567890йфяцычувскамепинртгоьшлбщдюзжхэъ- ЙФЯЦЫЧУВСКАМЕПИНРТГОЬШЛБЩДЮЗЖХЭЪ ";var F="";var K;var H;for(var J=0;J<L.length;J++){K=L[J];H=I.indexOf(K);if(H>-1){F+=G[H];continue}F+=K}return F}function t(F,G){if(!F){return}p.trigger("kladr_"+F,G);if(i[F]){i[F].call(p.get(0),G)}}function m(){if(g){return}var F=-0.2;g=setInterval(function(){if(!j.is(":visible")){clearInterval(g);g=null;return}j.css("background-position","0% "+F+"%");F+=5.555556;if(F>95){F=-0.2}},30)}function D(){if(i.showSpinner){j.show();m()}}function r(){j.hide()}}}})(jQuery);