!function(e){function t(e){var t={},r={type:"contentType",name:"query",withParents:"withParent"};e.parentType&&e.parentId&&(t[e.parentType+"Id"]=e.parentId);for(var i in e)n(e,i)&&e[i]&&(t[n(r,i)?r[i]:i]=e[i]);return t}function n(e,t){return e.hasOwnProperty(t)}function r(e){var t=window.console;t&&t.error&&t.error(e)}e.kladr={},e.kladr.url="http://kladr-api.ru/api.php",e.kladr.type={region:"region",district:"district",city:"city",street:"street",building:"building"},e.kladr.typeCode={city:1,settlement:2,village:4},e.kladr.validate=function(t){var n=e.kladr.type;switch(t.type){case n.region:case n.district:case n.city:if(t.parentType&&!t.parentId)return r("parentId undefined"),!1;break;case n.street:if(t.parentType!=n.city)return r('parentType must equal "city"'),!1;if(!t.parentId)return r("parentId undefined"),!1;break;case n.building:if(!t.zip){if(t.parentType!=n.street)return r('parentType must equal "street"'),!1;if(!t.parentId)return r("parentId undefined"),!1}break;default:if(!t.oneString)return r("type incorrect"),!1}return t.oneString&&t.parentType&&!t.parentId?(r("parentId undefined"),!1):t.typeCode&&t.type!=n.city?(r('type must equal "city"'),!1):t.limit<1?(r("limit must greater than 0"),!1):!0},e.kladr.api=function(n,i){if(!i)return void r("Callback undefined");if(!e.kladr.validate(n))return void i([]);var a=setTimeout(function(){i([]),a=null},3e3);e.getJSON(e.kladr.url+"?callback=?",t(n),function(e){a&&(i(e.result||[]),clearTimeout(a))})},e.kladr.check=function(t,n){return n?(t.withParents=!1,t.limit=1,void e.kladr.api(t,function(e){n(e&&e.length?e[0]:!1)})):void r("Callback undefined")}}(jQuery),function(e,t){function n(t,n){function r(e,t){return e.isGet?d.get(e.str[0]):(d.set(e),void t())}var d=function(){var n="kladr-data",r=t.data(n);return r||(r=e.extend({},o,l),t.data(n,r)),{set:function(e){if(e.obj)for(var i in e.obj)a(e.obj,i)&&a(o,i)&&(r[i]=e.obj[i]);else e.str&&!e.isGet&&a(o,e.str[0])&&(r[e.str[0]]=e.str[1]);t.data(n,r)},get:function(e){return a(o,e)||a(l,e)?r[e]:void 0},_set:function(e,i){r[e]=i,t.data(n,r)},_get:function(e){return a(r,e)?r[e]:void 0}}}();return r(n,function(){function n(n){var r=e(document.getElementById("kladr_autocomplete"));r.length||(r=e('<div id="kladr_autocomplete"></div>').appendTo(document.body));var a=j("guid");a?(_=r.find(".autocomplete"+a),B=r.find(".spinner"+a),e(window).off(x),t.off(x),_.off(x)):(a=i(),S("guid",a),t.attr("autocomplete","off"),_=e('<ul class="autocomplete'+a+' autocomplete" style="display: none;"></ul>').appendTo(r),B=e('<div class="spinner'+a+' spinner" style="display: none;"></div>').appendTo(r),y(),o(),h()),n()}function r(t,n){var r,i,o,l;_.empty();for(var u in t)a(t,u)&&(r=t[u],i=j("valueFormat")(r,n),o=j("labelFormat")(r,n),l=e('<a data-val="'+i+'">'+o+"</a>"),l.data("kladr-object",r),e("<li></li>").append(l).appendTo(_))}function o(){var e=t.offset(),n=t.outerWidth(),r=t.outerHeight();if(o.top!=e.top||o.left!=e.left||o.width!=n||o.height!=r){o.top=e.top,o.left=e.left,o.width=n,o.height=r,_.css({top:e.top+r+"px",left:e.left});var i=_.outerWidth()-_.width();_.width(n-i);var a=B.width(),l=B.height();B.css({top:e.top+(r-l)/2-1,left:e.left+n-a-2})}}function l(n){if(!(n.which>8&&n.which<46)){if(!k("open_before"))return void s();C(null);var i=t.val();if(!e.trim(i))return I(!1),void s();var a=b(i);if(!k("send_before",a))return void s();g(),k("send"),j("source")(a,function(n){return k("receive"),t.is(":focus")?e.trim(t.val())&&n.length?(r(n,a),o(),m(),_.slideDown(50),void k("open")):(m(),C(null),void s()):(m(),void s())})}}function s(){k("close_before")&&(_.empty().hide(),k("close"))}function c(e){var t=_.find("li.active");switch(e.which){case u.up:t.length?(t.removeClass("active"),t.prev().length&&(t=t.prev())):t=_.find("li").last(),function(){var e=_.scrollTop(),n=_.offset(),r=t.outerHeight(),i=t.offset();i.top-n.top<0&&_.scrollTop(e-r)}(),t.addClass("active"),p();break;case u.down:t.length?(t.removeClass("active"),t.next().length&&(t=t.next())):t=_.find("li").first(),function(){var e=_.scrollTop(),n=_.height(),r=_.offset(),i=t.outerHeight(),a=t.offset();a.top-r.top+i>n&&_.scrollTop(e+i)}(),t.addClass("active"),p();break;case u.enter:s()}}function f(){var n=e(this);return n.is("a")&&(n=n.parents("li")),n.addClass("active"),p(),s(),t.focus(),!1}function p(){if(k("select_before")){var e=_.find(".active a");e.length&&(t.val(e.attr("data-val")),I(!1),C(e.data("kladr-object")),k("select",j("current")))}}function v(){function n(e,t){I(t),C(e)}if(j("verify")&&k("check_before")){var r=e.trim(t.val());if(!r)return n(null,!1),void k("check",null);if(j("current"))return void I(!1);var i=b(r);if(i.withParents=!1,i.limit=10,!k("send_before",i))return n(null,!1),void k("check",null);g(),k("send"),j("source")(i,function(r){function o(e,t){m(),n(e,t)}if(k("receive"),!e.trim(t.val()))return void o(null,!1);var l=i.name.toLowerCase(),u=null,d=null;for(var s in r)if(a(r,s)&&(u=r[s].name.toLowerCase(),l==u)){d=r[s];break}d&&t.val(j("valueFormat")(d,i)),o(d,!d),k("check",d)})}}function y(){function n(e,n){t.val(e?j("valueFormat")(e,n):""),C(e)}var r={setValue:function(t){return"object"===e.type(t)?r.setValueByObject(t):"number"===e.type(t)?r.setValueById(t):"string"===e.type(t)?r.setValueByName(t):t?r:r.clear()},setValueByName:function(t){if(t=e.trim(t+"")){var i=b("");if(i.name=T(t),i.withParents=!1,i.limit=10,!k("send_before",i))return n(null,i),r;k("send"),j("source")(i,function(e){k("receive");var t=i.name.toLowerCase(),r=null,o=null;for(var l in e)if(a(e,l)&&(r=e[l].name.toLowerCase(),t==r)){o=e[l];break}n(o,i)})}return r},setValueById:function(t){var i=b("");return i.parentType=i.type,i.parentId=t,i.limit=1,e.kladr.api(i,function(e){e.length&&n(e[0],i)}),r},setValueByObject:function(e){return n(e,b("")),r},clear:function(){return n(null,null),r}};S("controller",r)}function h(){function n(){var n=t.val();if(n){var r=b(n),i=r.type,a=r.parentType,o=e.kladr.type,l=!0;return i==o.street&&a!=o.city&&(l=!1),i==o.building&&a!=o.street&&(l=!1),l&&v(),!!j("current")}return!1}var r=0;!function i(){++r>5||n()||setTimeout(i,100)}()}function k(n,r){if(!n)return!0;var i=n.replace(/_([a-z])/gi,function(e,t){return t.toUpperCase()});return t.trigger("kladr_"+n,r),"function"===e.type(j(i))?j(i).call(t.get(0),r)!==!1:!0}function g(){j("spinner")&&j("showSpinner")(B)}function m(){j("spinner")&&j("hideSpinner")(B)}function b(e){var t,n={},r=["token","key","type","typeCode","parentType","parentId","oneString","withParents","limit"];for(t=0;t<r.length;t++)n[r[t]]=j(r[t]);n.name=T(e);var i,a=j("parentInput");return a&&(i=w(a,n.type),i&&(n.parentType=i.type,n.parentId=i.id)),n.oneString&&(n.withParents=!0),n}function w(t,n){var r,i=e.kladr.getInputs(t),o=e.kladr.type,l={},u=null;i.each(function(){var t,n=e(this);(t=n.attr("data-kladr-id"))&&(l[n.attr("data-kladr-type")]=t)});for(r in o){if(r==n)return u;a(o,r)&&l[r]&&(u={type:r,id:l[r]})}return u}function T(e){for(var t="abcdefghijklmnopqrstuvwxyz",n=e.toLowerCase(),r=0;r<n.length;r++)if(~t.indexOf(n[r]))return I(!0),e;return I(!1),e}function C(e){S("current",e),e&&e.id?t.attr("data-kladr-id",e.id):t.removeAttr("data-kladr-id"),j("oneString")&&e&&e.contentType&&t.attr("data-kladr-type",e.contentType)}function I(e){e?t.addClass("kladr-error"):t.removeClass("kladr-error")}function j(e){return d._get(e)}function S(e,t){d._set(e,t)}var _=null,B=null,x=".kladr";n(function(){var n=!1;t.attr("data-kladr-type",j("type")||"").attr("data-kladr-one-string",j("oneString")||null).on("keyup"+x,l).on("keydown"+x,c).on("blur"+x+" change"+x,function(){n||(v(),s())}),_.on("touchstart"+x+" click"+x,"li, a",function(){n=!0,f.call(this),n=!1}).on("mouseenter"+x,function(){n=!0}).on("mouseleave"+x,function(){n=!1}),e(window).on("resize"+x,o)})})}function r(n){var r={obj:!1,str:!1,isGet:!1};return"object"===e.type(n)?(r.obj=n,r):("string"===e.type(n)&&(r.str=arguments,r.isGet=arguments[1]===t),r)}function i(){return i.guid?++i.guid:i.guid=1}function a(e,t){return e.hasOwnProperty(t)}var o={token:null,key:null,type:null,typeCode:null,parentType:null,parentId:null,limit:10,oneString:!1,withParents:!1,parentInput:null,verify:!1,spinner:!0,open:null,close:null,send:null,receive:null,select:null,check:null,openBefore:null,closeBefore:null,sendBefore:null,selectBefore:null,checkBefore:null,source:function(t,n){e.kladr.api(t,n)},labelFormat:function(t,n){var r;if(n.oneString)return t.parents?(r=e.extend(!0,[],t.parents),r.push(t),e.kladr.buildAddress(r)):(t.typeShort?t.typeShort+". ":"")+t.name;var i,a,o,l,u="";return t.typeShort&&(u+=t.typeShort+". "),i=t.name,a=i.toLowerCase(),o=n.name.toLowerCase(),l=a.indexOf(o),l=~l?l:0,o.length<a.length?(u+=i.substr(0,l),u+="<strong>"+i.substr(l,o.length)+"</strong>",u+=i.substr(l+o.length)):u+="<strong>"+i+"</strong>",u},valueFormat:function(t,n){var r;return n.oneString?t.parents?(r=e.extend(!0,[],t.parents),r.push(t),e.kladr.buildAddress(r)):(t.typeShort?t.typeShort+". ":"")+t.name:t.name},showSpinner:function(e){var t=-.2,n=setInterval(function(){return e.is(":visible")?(e.css("background-position","0% "+t+"%"),t+=5.555556,void(t>95&&(t=-.2))):(clearInterval(n),void(n=null))},30);e.show()},hideSpinner:function(e){e.hide()}},l={current:null,controller:null},u={up:38,down:40,enter:13};e.kladr=e.extend(e.kladr,{setDefault:function(e,t){var n=r(e,t);if(n.obj)for(var i in n.obj)a(o,i)&&(o[i]=n.obj[i]);else n.str&&!n.isGet&&a(o,n.str[0])&&(o[n.str[0]]=n.str[1])},getDefault:function(e){return a(o,e)?o[e]:void 0},getInputs:function(t){var n=e(t||document.body),r="[data-kladr-type]";return n.filter(r).add(n.find(r))},getAddress:function(t,n){var r,i=e.kladr.getInputs(t),o=e.kladr.type,l={},u={};i.each(function(){var t,n,r,i=e(this);if(i.attr("data-kladr-id"))if(t=i.kladr("current"),i.attr("data-kladr-one-string")&&t.parents){n=e.extend(!0,[],t.parents),n.push(t);for(r in n)a(n,r)&&(l[n[r].contentType]=n[r])}else l[i.attr("data-kladr-type")]=t;else l[i.attr("data-kladr-type")]=i.val()});for(r in o)a(o,r)&&l[r]&&(u[r]=l[r]);return(n||e.kladr.buildAddress)(u)},buildAddress:function(t){var n,r,i=[],o="",l="",u="",d="";e:for(n in t)if(a(t,n)){if("object"===e.type(t[n])){for(r=0;r<i.length;r++)if(i[r]==t[n].id)continue e;i.push(t[n].id),u=t[n].name,d=t[n].typeShort+". ",l=t[n].zip||l}else u=t[n],d="";o&&(o+=", "),o+=d+u}return o=(l?l+", ":"")+o}}),e.fn.kladr=function(t,i){var a=r(t,i),o=null;return this.each(function(){var t=n(e(this),a);return a.isGet?(o=t,!1):void 0}),a.isGet?o:this}}(jQuery),function(e){e.fn.kladrZip=function(t){var n=e(t||document.body);return this.keydown(function(t){var n=t.charCode||t.keyCode||0,r=8==n||9==n||13==n||46==n||110==n||190==n||n>=35&&40>=n||n>=96&&105>=n;return e(this).val().length>=6?r:r||n>=48&&57>=n}),this.keyup(function(){function t(e){e?r.addClass("kladr-error"):r.removeClass("kladr-error")}var r=e(this),i=r.val();return i?void e.kladr.api({type:e.kladr.type.building,zip:i,withParents:!0,limit:1},function(r){var i,a,o=r.length&&r[0];if(r=[],o){t(!1),o.parents&&(r=e.extend(!0,[],o.parents)),r.push(o);for(i in r)r.hasOwnProperty(i)&&(a=n.find('[data-kladr-type="'+r[i].contentType+'"]'),a.kladr("controller").setValueByObject(r[i]))}else t(!0)}):void t(!1)}),this}}(jQuery);