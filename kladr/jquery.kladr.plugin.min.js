!function(t,e){function n(n,r){function u(t,n){return t.isGet?s.get(t.str[0]):(s.set(t),n(),e)}var s=function(){var r=n.data("kladr-data");return r||(r=t.extend({},o,i),n.data("kladr-data",r)),{set:function(t){if(t.obj)for(var e in t.obj)t.obj.hasOwnProperty(e)&&o.hasOwnProperty(e)&&(r[e]=t.obj[e]);else t.str&&t.str.length>1&&o.hasOwnProperty(t.str[0])&&(r[t.str[0]]=t.str[1]);n.data("kladr-data",r)},get:function(t){return o.hasOwnProperty(t)||i.hasOwnProperty(t)?r[t]:e},_set:function(t,e){r[t]=e,n.data("kladr-data",r)},_get:function(t){return r.hasOwnProperty(t)?r[t]:e}}}();return u(r,function(){function r(e){var r=t(document.getElementById("kladr_autocomplete"));r.length||(r=t('<div id="kladr_autocomplete"></div>').appendTo(document.body));var o=O("guid");o?(T=r.find(".autocomplete"+o),_=r.find(".spinner"+o),n.off(".kladr"),T.off(".kladr")):(o=a(),j("guid",o),n.attr("autocomplete","off"),T=t('<ul class="autocomplete'+o+' autocomplete" style="display: none;"></ul>').appendTo(r),_=t('<div class="spinner'+o+' spinner" style="display: none;"></div>').appendTo(r),i()),e()}function o(e,n){var r,a,o,i;T.empty();for(var l in e)e.hasOwnProperty(l)&&(r=e[l],a=O("valueFormat")(r,n),o=O("labelFormat")(r,n),i=t('<a data-val="'+a+'">'+o+"</a>"),i.data("kladr-object",r),t("<li></li>").append(i).appendTo(T))}function i(){var t=n.offset(),e=n.outerWidth(),r=n.outerHeight();if(i.top!=t.top||i.left!=t.left||i.width!=e||i.height!=r){i.top=t.top,i.left=t.left,i.width=e,i.height=r,T.css({top:t.top+r+"px",left:t.left});var a=T.outerWidth()-T.width();T.width(e-a);var o=_.width(),l=_.height();_.css({top:t.top+(r-l)/2-1,left:t.left+e-o-2})}}function u(e){if(!(e.which>8&&e.which<46)){if(!h("open_before"))return void d();var r=n.val();if(!t.trim(r))return P(!1),void d();var a=g(r);if(!h("send_before",a))return void d();k(),h("send"),O("source")(a,function(e){return h("received"),n.is(":focus")&&t.trim(n.val())&&e.length?(o(e,a),i(),y(),T.slideDown(50),void h("open")):(y(),void d())})}}function d(){h("close_before")&&(T.empty().hide(),h("close"))}function f(t){var n=T.find("li.active");switch(t.which){case l.up:n.length?(n.removeClass("active"),n.prev().length&&(n=n.prev())):n=T.find("li").last(),function(){var t=T.scrollTop(),e=T.offset(),r=n.outerHeight(),a=n.offset();a.top-e.top<0&&T.scrollTop(t-r)}(),n.addClass("active"),p();break;case l.down:n.length?(n.removeClass("active"),n.next().length&&(n=n.next())):n=T.find("li").first(),function(){var t=T.scrollTop(),e=T.height(),r=T.offset(),a=n.outerHeight(),o=n.offset();o.top-r.top+a>e&&T.scrollTop(t+a)}(),n.addClass("active"),p();break;case l.enter:d()}return e}function c(){var e=t(this);return e.is("a")&&(e=e.parents("li")),e.addClass("active"),p(),d(),n.focus(),!1}function p(){if(h("select_before")){var t=T.find(".active a");t.length&&(n.val(t.attr("data-val")),P(!1),b(t.data("kladr-object")),h("select",O("current")))}}function v(){function e(t,e){P(e),b(t)}if(O("verify")&&h("check_before")){var r=t.trim(n.val());if(!r)return void e(null,!1);var a=g(r);if(a.withParents=!1,a.limit=10,!h("send_before",a))return e(null,!1),void h("check",null);k(),h("send"),O("source")(a,function(r){function o(t,n){y(),e(t,n)}if(h("received"),!t.trim(n.val()))return void o(null,!1);var i=a.name.toLowerCase(),l=null,u=null;for(var s in r)if(r.hasOwnProperty(s)&&(l=r[s].name.toLowerCase(),i==l)){u=r[s];break}u&&n.val(O("valueFormat")(u,a)),o(u,!u),h("check",u)})}}function h(e,r){if(!e)return!0;var a=e.replace(/_([a-z])/gi,function(t,e){return e.toUpperCase()});return n.trigger("kladr_"+e,r),"function"===t.type(O(a))?O(a).call(n.get(0),r):!0}function k(){O("spinner")&&O("showSpinner")(_)}function y(){O("spinner")&&O("hideSpinner")(_)}function g(t){var e,n={token:O("token"),key:O("key"),type:O("type"),name:w(t),parentType:O("parentType"),parentId:O("parentId"),withParents:O("withParents"),limit:O("limit")},r=O("parentInput");return r&&(e=m(r,n.type),e&&(n.parentType=e.type,n.parentId=e.id)),n}function m(e,n){var r,a=t.kladr.getInputs(e),o=t.kladr.getTypes(),i={},l=null;a.each(function(){var e,n=t(this);(e=n.attr("data-kladr-id"))&&(i[n.attr("data-kladr-type")]=e)});for(r in o){if(r==n)return l;o.hasOwnProperty(r)&&i[r]&&(l={type:r,id:i[r]})}return l}function w(t){for(var e,n,r="abcdefghijklmnopqrstuvwxyz",a="Ёё",o="Ее",i=t.toLowerCase(),l="",u=0;u<i.length;u++){if(r.indexOf(i[u])>-1)return P(!0),t;e=t[u],n=a.indexOf(e),l+=n>-1?o[n]:e}return P(!1),l}function b(t){j("current",t),t&&t.id&&n.attr("data-kladr-id",t.id)}function P(t){t?n.addClass("kladr-error"):n.removeClass("kladr-error")}function O(t){return s._get(t)}function j(t,e){s._set(t,e)}var T=null,_=null;r(function(){var t=!1;n.attr("data-kladr-type",O("type")).on("keyup.kladr",u).on("keydown.kladr",f).on("blur.kladr",function(){v(),t||d()}),T.on("touchstart.kladr click.kladr","li, a",c).on("touchstart.kladr mouseenter.kladr","li",function(){t=!0}).on("touchend.kladr mouseleave.kladr","li",function(){t=!1})})})}function r(n){var r={obj:!1,str:!1,isGet:!1};if("object"===t.type(n))return r.obj=n,r;if("string"===t.type(n)){r.str=[];for(var a in arguments)arguments.hasOwnProperty(a)&&(r.str[a]=arguments[a]);r.str[1]===e&&(r.isGet=!0)}return r}function a(){return a.guid||(a.guid=0),++a.guid}var o={token:null,key:null,type:null,parentType:null,parentId:null,limit:10,withParents:!1,parentInput:null,verify:!1,spinner:!0,open:null,close:null,send:null,received:null,select:null,check:null,openBefore:null,closeBefore:null,sendBefore:null,selectBefore:null,checkBefore:null,source:function(e,n){t.kladr.api(e,n)},labelFormat:function(t,e){var n="",r=t.name.toLowerCase(),a=e.name.toLowerCase(),o=r.indexOf(a);return o=o>0?o:0,t.typeShort&&(n+=t.typeShort+". "),a.length<r.length?(n+=t.name.substr(0,o),n+="<strong>"+t.name.substr(o,a.length)+"</strong>",n+=t.name.substr(o+a.length,r.length-a.length-o)):n+="<strong>"+t.name+"</strong>",n},valueFormat:function(t){return t.name},showSpinner:function(t){var e=-.2,n=setInterval(function(){return t.is(":visible")?(t.css("background-position","0% "+e+"%"),e+=5.555556,void(e>95&&(e=-.2))):(clearInterval(n),void(n=null))},30);t.show()},hideSpinner:function(t){t.hide()}},i={current:null},l={up:38,down:40,enter:13};t.fn.kladr=function(a,o){var i=r(a,o),l=e;return this.each(function(){var r=n(t(this),i);return i.isGet?(l=r,!1):e}),i.isGet?l:this},t.kladr=t.extend(t.kladr,{setDefault:function(t,e){var n=r(t,e);if(n.obj)for(var a in n.obj)o.hasOwnProperty(a)&&(o[a]=n.obj[a]);else n.str&&n.str.length>1&&o.hasOwnProperty(n.str[0])&&(o[n.str[0]]=n.str[1])},getDefault:function(t){return o.hasOwnProperty(t)?o[t]:e},getTypes:function(){return t.kladr.type},getInputs:function(e){var n=t(),r="[data-kladr-type]";return t(e||document.body).each(function(){var e=t(this);n=n.add(e.is(r)?e:e.find(r))}),n}})}(jQuery);