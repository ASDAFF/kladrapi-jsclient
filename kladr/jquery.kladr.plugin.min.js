!function(e,t){e.fn.kladr=function(r,n){function a(r,n,a){function i(n,a,i){if(T=r.data("kladr-options"),a!==t)return T[n]=a,r.data("kladr-options",T),r;if("string"===e.type(n))return T?T[n]:null;if(T)return r;if(T=I,"object"===e.type(n))for(var o in n)T[o]=n[o];return r.data("kladr-options",T),i&&i(),r}function o(){var t=e(document.getElementById("kladr_autocomplete")),n=r.attr("name");t.length||(t=e('<div id="kladr_autocomplete"></div>').appendTo("body")),r.attr("autocomplete","off"),b=e('<ul class="kladr_autocomplete_'+n+'" style="display: none;"></ul>'),b.appendTo(t),C=e('<div class="spinner kladr_autocomplete_'+n+'_spinner" class="spinner" style="display: none;"></div>'),C.appendTo(t)}function l(t,r){b.empty();for(var n in t){var a=t[n],i=T.valueFormat(a,r),o=T.labelFormat(a,r),l=e('<a data-val="'+i+'">'+o+"</a>");l.data("kladr-object",a);var c=e("<li></li>").append(l);c.appendTo(b)}}function c(){var e=r.offset(),t=r.outerWidth(),n=r.outerHeight();b.css({top:e.top+n+"px",left:e.left});var a=b.outerWidth()-b.width();b.width(t-a);var i=C.width(),o=C.height();C.css({top:e.top+(n-o)/2-1,left:e.left+t-i-2})}function s(t){if(!(t.which>8&&t.which<46)&&d()){var n=k(r.val());if(!e.trim(n))return void u();g(),m("send"),T.source(n,function(t){return w(),m("received"),r.is(":focus")&&e.trim(r.val())&&t.length?(l(t,n),c(),b.slideDown(50),void m("open")):void u()})}}function u(){p(),b.hide(),m("close")}function d(){switch(T.type){case e.kladr.type.region:case e.kladr.type.district:case e.kladr.type.city:if(T.parentType&&!T.parentId)return console.error("parentType is defined and parentId in not"),!1;break;case e.kladr.type.street:if(T.parentType!=e.kladr.type.city)return console.error('For street parentType must equal "city"'),!1;if(!T.parentId)return console.error("For street parentId must defined"),!1;break;case e.kladr.type.building:if(T.parentType!=e.kladr.type.street)return console.error('For building parentType must equal "street"'),!1;if(!T.parentId)return console.error("For building parentId must defined"),!1;break;default:return console.error('type must defined and equal "region", "district", "city", "street" or "building"'),!1}return T.limit<1?(console.error("limit must greater than 0"),!1):!0}function p(){var e=b.find(".active a");e.length&&(r.val(e.attr("data-val")),T.current=e.data("kladr-object"),r.data("kladr-options",T),m("select",T.current))}function f(e){var t=b.find("li.active");switch(e.which){case F.up:t.length?(t.removeClass("active"),t=t.prev()):t=b.find("li").last(),t.addClass("active");var r=t.find("a").data("kladr-object");m("preselect",r),T.arrowSelect&&p();break;case F.down:t.length?(t.removeClass("active"),t=t.next()):t=b.find("li").first(),t.addClass("active");var r=t.find("a").data("kladr-object");m("preselect",r),T.arrowSelect&&p();break;case F.esc:t.removeClass("active"),u();break;case F.enter:return T.arrowSelect||p(),t.removeClass("active"),u(),!1}}function v(){return u(),r.focus(),!1}function h(){if(T.verify){if(!d())return T.current=null,r.data("kladr-options",T),void m("check",T.current);var t=k(r.val());if(!e.trim(t))return T.current=null,r.data("kladr-options",T),void m("check",T.current);g(),m("send"),T.source(t,function(e){w(),m("received");for(var n=null,a=0;a<e.length;a++){var i=t.toLowerCase(),o=e[a].name.toLowerCase();if(i==o){n=e[a];break}}n&&r.val(T.valueFormat(n,t)),T.current=n,r.data("kladr-options",T),m("check",T.current)})}}function k(e){for(var t,r,n="1234567890qazwsxedcrfvtgbyhnujmik,ol.p;[']- QAZWSXEDCRFVTGBYHNUJMIK<OL>P:{\"} ",a="1234567890йфяцычувскамепинртгоьшлбщдюзжхэъ- ЙФЯЦЫЧУВСКАМЕПИНРТГОЬШЛБЩДЮЗЖХЭЪ ",i="",o=0;o<e.length;o++)t=e[o],r=n.indexOf(t),i+=r>-1?a[r]:t;return i}function m(e,t){e&&(r.trigger("kladr_"+e,t),T[e]&&T[e].call(r.get(0),t))}function y(){if(!S){var e=-.2;S=setInterval(function(){return C.is(":visible")?(C.css("background-position","0% "+e+"%"),e+=5.555556,void(e>95&&(e=-.2))):(clearInterval(S),void(S=null))},30)}}function g(){T.showSpinner&&(C.show(),y())}function w(){C.hide()}var b=null,C=null,T=null,I={token:null,key:null,type:null,parentType:null,parentId:null,limit:10,withParents:!1,verify:!1,showSpinner:!0,arrowSelect:!0,current:null,open:null,close:null,send:null,received:null,select:null,check:null,source:function(t,r){var n={token:T.token,key:T.token,type:T.type,name:t,parentType:T.parentType,parentId:T.parentId,withParents:T.withParents,limit:T.limit};e.kladr.api(n,r)},labelFormat:function(e,t){var r="",n=e.name.toLowerCase();t=t.toLowerCase();var a=n.indexOf(t);return a=a>0?a:0,e.typeShort&&(r+=e.typeShort+". "),t.length<e.name.length?(r+=e.name.substr(0,a),r+="<strong>"+e.name.substr(a,t.length)+"</strong>",r+=e.name.substr(a+t.length,e.name.length-t.length-a)):r+="<strong>"+e.name+"</strong>",r},valueFormat:function(e){return e.name}},F={up:38,down:40,esc:27,enter:13},S=null;return i(n,a,function(){var t=!1;o(),c(),r.on("keyup",s).on("keydown",f).on("change",function(){t||h()}).on("blur",function(){t||u()}),b.on("click","li, a",v).on("touchstart mouseenter","li",function(){var r=e(this);b.find("li.active").removeClass("active"),r.addClass("active");var n=r.find("a").data("kladr-object");m("preselect",n),t=!0}).on("touchleave mouseleave","li",function(){e(this).removeClass("active"),t=!1}),e(window).on("resize",c)})}var i=t;return this.each(function(){var o=a(e(this),r,n);i==t&&(i=o)}),i}}(jQuery);