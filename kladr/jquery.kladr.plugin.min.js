(function(b,a){b.fn.kladr=function(j,m){var u=this;var p=null;var i=null;var s=null;var f={token:null,key:null,type:null,parentType:null,parentId:null,limit:10,withParents:false,verify:false,showSpinner:true,current:null,open:null,close:null,send:null,received:null,select:null,check:null,source:function(A,B){var z={token:s.token,key:s.token,type:s.type,name:A,parentType:s.parentType,parentId:s.parentId,withParents:s.withParents,limit:s.limit};b.kladr.api(z,B)},labelFormat:function(C,A){var z="";var D=C.name.toLowerCase();A=A.toLowerCase();var B=D.indexOf(A);B=B>0?B:0;if(C.typeShort){z+=C.typeShort+". "}if(A.length<C.name.length){z+=C.name.substr(0,B);z+="<strong>"+C.name.substr(B,A.length)+"</strong>";z+=C.name.substr(B+A.length,C.name.length-A.length-B)}else{z+="<strong>"+C.name+"</strong>"}return z},valueFormat:function(A,z){return A.name}};var v={up:38,down:40,esc:27,enter:13};var l=function(A,B,C){s=u.data("kladr-options");if(B!==a){s[A]=B;u.data("kladr-options",s);return u}if(b.type(A)==="string"){if(!s){return null}return s[A]}if(s){return u}s=f;if(b.type(A)==="object"){for(var z in A){s[z]=A[z]}}u.data("kladr-options",s);C&&C();return u};var t=function(C){var D="1234567890qazwsxedcrfvtgbyhnujmik,ol.p;[']- QAZWSXEDCRFVTGBYHNUJMIK<OL>P:{\"} ";var A="1234567890йфяцычувскамепинртгоьшлбщдюзжхэъ- ЙФЯЦЫЧУВСКАМЕПИНРТГОЬШЛБЩДЮЗЖХЭЪ ";var F="";var B;var E;for(var z=0;z<C.length;z++){B=C[z];E=D.indexOf(B);if(E>-1){F+=A[E];continue}F+=B}return F};var o=function(z,A){if(!z){return}u.trigger("kladr_"+z,A);s[z]&&s[z](A)};var e=function(){var A=b(document.getElementById("kladr_autocomplete"));var z=u.attr("name");if(!A.length){A=b('<div id="kladr_autocomplete"></div>').appendTo("body")}u.attr("autocomplete","off");p=b('<ul class="kladr_autocomplete_'+z+'" style="display: none;"></ul>');p.appendTo(A);i=b('<div class="spinner kladr_autocomplete_'+z+'_spinner" class="spinner"  style="display: none;"></div>');i.appendTo(A);d()};var d=function(){if(s.showSpinner){var z=-0.2;setInterval(function(){i.css("background-position","0% "+z+"%");z+=5.585;if(z>95){z=-0.2}},30)}};var w=function(){var A=u.offset();var B=u.outerWidth();var z=u.outerHeight();p.css({top:A.top+z+"px",left:A.left});var C=p.outerWidth()-p.width();p.width(B-C);i.css({top:A.top,left:A.left+B-z,});i.width(z).height(z)};var h=function(D,F){p.empty();for(var A in D){var G=D[A];var z=s.valueFormat(G,F);var B=s.labelFormat(G,F);var C=b('<a data-val="'+z+'">'+B+"</a>");C.data("kladr-object",G);var E=b("<li></li>").append(C);E.appendTo(p)}};var r=function(){var z=p.find(".active a");if(!z.length){return}u.val(z.attr("data-val"));s.current=z.data("kladr-object");u.data("kladr-options",s);o("select",s.current)};var q=function(){var z=b(this);if(z.is("li")){z=z.find("a")}r(z);x();u.focus();return false};var c=function(z){var A=p.find("li.active");switch(z.which){case v.up:if(A.length){A.removeClass("active");A=A.prev()}else{A=p.find("li").last()}A.addClass("active");r();break;case v.down:if(A.length){A.removeClass("active");A=A.next()}else{A=p.find("li").first()}A.addClass("active");r();break;case v.esc:x();break;case v.enter:x();return false}};var g=function(){if(!s.verify){return}var z=t(u.val());if(!b.trim(z)){return}y();o("send");s.source(z,function(B){k();o("received");var C=(B.length>0)?B[0]:false;if(C){var A=z.toLowerCase();var D=C.name.toLowerCase();C=(A==D)?C:false}if(C){u.val(s.valueFormat(C,z))}s.current=C;u.data("kladr-options",s);o("check",s.current)})};var n=function(A){if((A.which>8)&&(A.which<46)){return}var z=t(u.val());if(!b.trim(z)){x();return}y();o("send");s.source(z,function(B){k();o("received");if(!u.is(":focus")){x();return}if(!b.trim(u.val())||!B.length){x();return}h(B,z);w();p.slideDown(50);o("open")})};var x=function(){r();p.hide();o("close")};var y=function(){if(s.showSpinner){i.show()}};var k=function(){i.hide()};return l(j,m,function(){var z=false;e();w();u.keyup(n);u.keydown(c);u.change(g);u.blur(function(){if(!z){x()}});p.on("click","li, a",q);p.on("mouseenter","li",function(){b(this).addClass("active");z=true});p.on("mouseleave","li",function(){b(this).removeClass("active");z=false});b(window).resize(w)})}})(jQuery);