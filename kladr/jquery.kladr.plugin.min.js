!function(e,t){function n(n,r){function u(e,n){return e.isGet?s.get(e.str[0]):(s.set(e),n(),t)}var s=function(){var r=n.data("kladr-data");return r||(r=e.extend({},a,i),n.data("kladr-data",r)),{set:function(e){if(e.obj)for(var t in e.obj)e.obj.hasOwnProperty(t)&&a.hasOwnProperty(t)&&(r[t]=e.obj[t]);else e.str&&e.str.length>1&&a.hasOwnProperty(e.str[0])&&(r[e.str[0]]=e.str[1]);n.data("kladr-data",r)},get:function(e){return a.hasOwnProperty(e)||i.hasOwnProperty(e)?r[e]:t},_set:function(e,t){r[e]=t,n.data("kladr-data",r)},_get:function(e){return r.hasOwnProperty(e)?r[e]:t}}}();return u(r,function(){function r(t){var r=e(document.getElementById("kladr_autocomplete"));r.length||(r=e('<div id="kladr_autocomplete"></div>').appendTo(document.body));var a=_("guid");a?(P=r.find(".autocomplete"+a),O=r.find(".spinner"+a),n.off(".kladr"),P.off(".kladr")):(a=o(),C("guid",a),n.attr("autocomplete","off"),P=e('<ul class="autocomplete'+a+' autocomplete" style="display: none;"></ul>').appendTo(r),O=e('<div class="spinner'+a+' spinner" style="display: none;"></div>').appendTo(r),i()),t()}function a(t,n){var r,o,a,i;P.empty();for(var l in t)t.hasOwnProperty(l)&&(r=t[l],o=_("valueFormat")(r,n),a=_("labelFormat")(r,n),i=e('<a data-val="'+o+'">'+a+"</a>"),i.data("kladr-object",r),e("<li></li>").append(i).appendTo(P))}function i(){var e=n.offset(),t=n.outerWidth(),r=n.outerHeight();if(i.top!=e.top||i.left!=e.left||i.width!=t||i.height!=r){i.top=e.top,i.left=e.left,i.width=t,i.height=r,P.css({top:e.top+r+"px",left:e.left});var o=P.outerWidth()-P.width();P.width(t-o);var a=O.width(),l=O.height();O.css({top:e.top+(r-l)/2-1,left:e.left+t-a-2})}}function u(t){if(!(t.which>8&&t.which<46)){if(!h("open_before"))return void c();var r=n.val();if(!e.trim(r))return b(!1),void c();var o=m(r);if(!h("send_before",o))return void c();g(),h("send"),_("source")(o,function(t){return h("received"),n.is(":focus")&&e.trim(n.val())&&t.length?(a(t,o),i(),k(),P.slideDown(50),void h("open")):(k(),void c())})}}function c(){h("close_before")&&(P.empty().hide(),h("close"))}function d(e){var n=P.find("li.active");switch(e.which){case l.up:n.length?(n.removeClass("active"),n.prev().length&&(n=n.prev())):n=P.find("li").last(),function(){var e=P.scrollTop(),t=P.offset(),r=n.outerHeight(),o=n.offset();o.top-t.top<0&&P.scrollTop(e-r)}(),n.addClass("active"),p();break;case l.down:n.length?(n.removeClass("active"),n.next().length&&(n=n.next())):n=P.find("li").first(),function(){var e=P.scrollTop(),t=P.height(),r=P.offset(),o=n.outerHeight(),a=n.offset();a.top-r.top+o>t&&P.scrollTop(e+o)}(),n.addClass("active"),p();break;case l.enter:c()}return t}function f(){var t=e(this);return t.is("a")&&(t=t.parents("li")),t.addClass("active"),p(),c(),n.focus(),!1}function p(){if(h("select_before")){var e=P.find(".active a");e.length&&(n.val(e.attr("data-val")),b(!1),w(e.data("kladr-object")),h("select",_("current")))}}function v(){function t(e,t){b(t),w(e)}if(_("verify")&&h("check_before")){var r=e.trim(n.val());if(!r)return void t(null,!1);var o=m(r);if(o.withParents=!1,o.limit=10,!h("send_before",o))return t(null,!1),void h("check",null);g(),h("send"),_("source")(o,function(r){function a(e,n){k(),t(e,n)}if(h("received"),!e.trim(n.val()))return void a(null,!1);var i=o.name.toLowerCase(),l=null,u=null;for(var s in r)if(r.hasOwnProperty(s)&&(l=r[s].name.toLowerCase(),i==l)){u=r[s];break}u&&n.val(_("valueFormat")(u,o)),a(u,!u),h("check",u)})}}function h(t,r){if(!t)return!0;var o=t.replace(/_([a-z])/gi,function(e,t){return t.toUpperCase()});return n.trigger("kladr_"+t,r),"function"===e.type(_(o))?_(o).call(n.get(0),r):!0}function g(){_("spinner")&&_("showSpinner")(O)}function k(){_("spinner")&&_("hideSpinner")(O)}function m(e){return{token:_("token"),key:_("key"),type:_("type"),name:y(e),parentType:_("parentType"),parentId:_("parentId"),withParents:_("withParents"),limit:_("limit")}}function y(e){for(var t,n,r="abcdefghijklmnopqrstuvwxyz",o="Ёё",a="Ее",i=e.toLowerCase(),l="",u=0;u<i.length;u++){if(r.indexOf(i[u])>-1)return b(!0),e;t=e[u],n=o.indexOf(t),l+=n>-1?a[n]:t}return b(!1),l}function w(e){C("current",e),e&&e.id&&n.attr("data-kladr-id",e.id)}function b(e){e?n.addClass("kladr-error"):n.removeClass("kladr-error")}function _(e){return s._get(e)}function C(e,t){s._set(e,t)}var P=null,O=null;r(function(){var e=!1;n.attr("data-kladr-type",_("type")).on("keyup.kladr",u).on("keydown.kladr",d).on("blur.kladr",function(){v(),e||c()}),P.on("touchstart.kladr click.kladr","li, a",f).on("touchstart.kladr mouseenter.kladr","li",function(){e=!0}).on("touchend.kladr mouseleave.kladr","li",function(){e=!1})})})}function r(n){var r={obj:!1,str:!1,isGet:!1};if("object"===e.type(n))return r.obj=n,r;if("string"===e.type(n)){r.str=[];for(var o in arguments)arguments.hasOwnProperty(o)&&(r.str[o]=arguments[o]);r.str[1]===t&&(r.isGet=!0)}return r}function o(){return o.guid||(o.guid=0),++o.guid}var a={token:null,key:null,type:null,parentType:null,parentId:null,limit:10,withParents:!1,verify:!1,spinner:!0,open:null,close:null,send:null,received:null,select:null,check:null,openBefore:null,closeBefore:null,sendBefore:null,selectBefore:null,checkBefore:null,source:function(t,n){e.kladr.api(t,n)},labelFormat:function(e,t){var n="",r=e.name.toLowerCase(),o=t.name.toLowerCase(),a=r.indexOf(o);return a=a>0?a:0,e.typeShort&&(n+=e.typeShort+". "),o.length<r.length?(n+=e.name.substr(0,a),n+="<strong>"+e.name.substr(a,o.length)+"</strong>",n+=e.name.substr(a+o.length,r.length-o.length-a)):n+="<strong>"+e.name+"</strong>",n},valueFormat:function(e){return e.name},showSpinner:function(e){var t=-.2,n=setInterval(function(){return e.is(":visible")?(e.css("background-position","0% "+t+"%"),t+=5.555556,void(t>95&&(t=-.2))):(clearInterval(n),void(n=null))},30);e.show()},hideSpinner:function(e){e.hide()}},i={current:null},l={up:38,down:40,enter:13};e.fn.kladr=function(o,a){var i=r(o,a),l=t;return this.each(function(){var r=n(e(this),i);return i.isGet?(l=r,!1):t}),i.isGet?l:this}}(jQuery);