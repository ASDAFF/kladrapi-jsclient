(function(b,a){b.fn.kladr=function(i,l){var t=this;var o=null;var h=null;var r=null;var e={token:null,key:null,type:null,parentType:null,parentId:null,limit:10,withParents:false,verify:false,showSpinner:true,current:null,open:null,close:null,send:null,received:null,select:null,check:null,source:function(z,A){var y={token:r.token,key:r.token,type:r.type,name:z,parentType:r.parentType,parentId:r.parentId,withParents:r.withParents,limit:r.limit};b.kladr.api(y,A)},labelFormat:function(B,z){var y="";var C=B.name.toLowerCase();z=z.toLowerCase();var A=C.indexOf(z);A=A>0?A:0;if(B.typeShort){y+=B.typeShort+". "}if(z.length<B.name.length){y+=B.name.substr(0,A);y+="<strong>"+B.name.substr(A,z.length)+"</strong>";y+=B.name.substr(A+z.length,B.name.length-z.length-A)}else{y+="<strong>"+B.name+"</strong>"}return y},valueFormat:function(z,y){return z.name}};var u={up:38,down:40,esc:27,enter:13};var k=function(z,A,B){r=t.data("kladr-options");if(A!==a){r[z]=A;t.data("kladr-options",r);return t}if(b.type(z)==="string"){if(!r){return null}return r[z]}if(r){return t}r=e;if(b.type(z)==="object"){for(var y in z){r[y]=z[y]}}t.data("kladr-options",r);B&&B();return t};var s=function(B){var C="1234567890qazwsxedcrfvtgbyhnujmik,ol.p;[']- QAZWSXEDCRFVTGBYHNUJMIK<OL>P:{\"} ";var z="1234567890йфяцычувскамепинртгоьшлбщдюзжхэъ- ЙФЯЦЫЧУВСКАМЕПИНРТГОЬШЛБЩДЮЗЖХЭЪ ";var E="";var A;var D;for(var y=0;y<B.length;y++){A=B[y];D=C.indexOf(A);if(D>-1){E+=z[D];continue}E+=A}return E};var n=function(y,z){if(!y){return}t.trigger("kladr_"+y,z);r[y]&&r[y](z)};var d=function(){var z=b(document.getElementById("kladr_autocomplete"));var y=t.attr("name");if(!z.length){z=b('<div id="kladr_autocomplete"></div>').appendTo("body")}t.attr("autocomplete","off");o=b('<ul class="kladr_autocomplete_'+y+'" style="display: none;"></ul>');o.appendTo(z);h=b('<div class="spinner kladr_autocomplete_'+y+'_spinner" class="spinner" style="display: none;"></div>');h.appendTo(z)};var v=function(){var z=t.offset();var A=t.outerWidth();var y=t.outerHeight();o.css({top:z.top+y+"px",left:z.left});var B=o.outerWidth()-o.width();o.width(A-B);h.css({top:z.top,left:z.left+A-y,});h.width(y).height(y)};var g=function(C,E){o.empty();for(var z in C){var F=C[z];var y=r.valueFormat(F,E);var A=r.labelFormat(F,E);var B=b('<a data-val="'+y+'">'+A+"</a>");B.data("kladr-object",F);var D=b("<li></li>").append(B);D.appendTo(o)}};var q=function(){var y=o.find(".active a");if(!y.length){return}t.val(y.attr("data-val"));r.current=y.data("kladr-object");t.data("kladr-options",r);n("select",r.current)};var p=function(){var y=b(this);if(y.is("li")){y=y.find("a")}q(y);w();t.focus();return false};var c=function(y){var z=o.find("li.active");switch(y.which){case u.up:if(z.length){z.removeClass("active");z=z.prev()}else{z=o.find("li").last()}z.addClass("active");q();break;case u.down:if(z.length){z.removeClass("active");z=z.next()}else{z=o.find("li").first()}z.addClass("active");q();break;case u.esc:w();break;case u.enter:w();return false}};var f=function(){if(!r.verify){return}var y=s(t.val());if(!b.trim(y)){return}x();n("send");r.source(y,function(A){j();n("received");var B=(A.length>0)?A[0]:false;if(B){var z=y.toLowerCase();var C=B.name.toLowerCase();B=(z==C)?B:false}if(B){t.val(r.valueFormat(B,y))}r.current=B;t.data("kladr-options",r);n("check",r.current)})};var m=function(z){if((z.which>8)&&(z.which<46)){return}var y=s(t.val());if(!b.trim(y)){w();return}x();n("send");r.source(y,function(A){j();n("received");if(!t.is(":focus")){w();return}if(!b.trim(t.val())||!A.length){w();return}g(A,y);v();o.slideDown(50);n("open")})};var w=function(){q();o.hide();n("close")};var x=function(){if(r.showSpinner){h.show()}};var j=function(){h.hide()};return k(i,l,function(){var y=false;d();v();t.keyup(m);t.keydown(c);t.change(f);t.blur(function(){if(!y){w()}});o.on("click","li, a",p);o.on("mouseenter","li",function(){b(this).addClass("active");y=true});o.on("mouseleave","li",function(){b(this).removeClass("active");y=false});b(window).resize(v)})}})(jQuery);